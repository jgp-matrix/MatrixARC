<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Matrix ARC</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{background:#0d0d14;color:#e8e8f0;font-family:-apple-system,'Inter',sans-serif;font-size:14px}
input,textarea,select,button{font-family:inherit;font-size:inherit}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#13131e}
::-webkit-scrollbar-thumb{background:#2a2a40;border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-in{animation:fadeIn 0.25s ease-out both}
.spin{animation:spin 1s linear infinite;display:inline-block}
@media print{.no-print{display:none!important}body{background:#fff!important}#quote-doc,#quote-doc *{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-functions-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs" type="module"></script>
<script>
// PDF.js setup â€” load via importShim after DOM ready
window.pdfjsReady=new Promise(res=>{
  const s=document.createElement("script");
  s.type="module";
  s.textContent=`import * as pdfjs from "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs";pdfjs.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.mjs";window._pdfjs=pdfjs;window._pdfjsResolve();`;
  window._pdfjsResolve=res;
  document.head.appendChild(s);
});
</script>
<script>
// â”€â”€ FIREBASE CONFIG â”€â”€ Replace with your MatrixARC Firebase project config
const firebaseConfig={
  apiKey:"AIzaSyCGgcsb-pV7ZpDDfUd6KQKaDetXUZPCTVw",
  authDomain:"matrix-arc.firebaseapp.com",
  projectId:"matrix-arc",
  storageBucket:"matrix-arc.firebasestorage.app",
  messagingSenderId:"198633509276",
  appId:"1:198633509276:web:852ce699c3ee3213643859"
};
firebase.initializeApp(firebaseConfig);
const fbAuth=firebase.auth();
const fbDb=firebase.firestore();
const fbFunctions=firebase.functions();
</script>
<script type="text/babel">
const {useState,useEffect,useRef}=React;

// â”€â”€ THEME â”€â”€
const C={
  bg:"#0d0d14",card:"#13131e",border:"#1e2030",
  accent:"#3b82f6",accentDim:"#1d3a6e",
  green:"#10b981",greenDim:"#052e1c",
  yellow:"#f59e0b",yellowDim:"#3a1f00",
  red:"#ef4444",redDim:"#3b0808",
  muted:"#6b7280",text:"#e8e8f0",sub:"#9ca3af",
  purple:"#8b5cf6",teal:"#14b8a6"
};

// â”€â”€ STYLE HELPERS â”€â”€
const btn=(bg,color,x={})=>({background:bg,color,border:"none",borderRadius:8,padding:"9px 16px",fontWeight:600,cursor:"pointer",fontSize:14,transition:"opacity 0.15s",...x});
const inp=(x={})=>({background:"#0a0a12",border:`1px solid ${C.border}`,borderRadius:8,padding:"9px 12px",color:C.text,fontSize:14,width:"100%",outline:"none",...x});
const card=(x={})=>({background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:20,...x});

// â”€â”€ API KEY (loaded from Firestore) â”€â”€
let _apiKey=null;
async function loadApiKey(uid){
  try{const d=await fbDb.doc(`users/${uid}/config/api`).get();if(d.exists)_apiKey=d.data().key||null;}catch(e){}
}

// â”€â”€ APP CONTEXT â”€â”€
let _appCtx={uid:null,companyId:null,role:null,projectsPath:null,configPath:null};
function isReadOnly(){return _appCtx.role==="view";}
function isAdmin(){return !!_appCtx.companyId&&_appCtx.role==="admin";}

// â”€â”€ PRICING CONFIG (loaded from Firestore) â”€â”€
let _pricingConfig={contingencyBOM:1500,contingencyConsumables:400,budgetaryContingencyPct:20};
async function loadPricingConfig(uid){
  try{
    const path=_appCtx.configPath?`${_appCtx.configPath}/pricing`:`users/${uid}/config/pricing`;
    const d=await fbDb.doc(path).get();
    if(d.exists){const c=d.data();_pricingConfig={contingencyBOM:c.contingencyBOM??1500,contingencyConsumables:c.contingencyConsumables??400,budgetaryContingencyPct:c.budgetaryContingencyPct??20};}
  }catch(e){}
}
async function savePricingConfig(uid,cfg){
  _pricingConfig=cfg;
  const path=_appCtx.configPath?`${_appCtx.configPath}/pricing`:`users/${uid}/config/pricing`;
  await fbDb.doc(path).set(cfg);
}
async function apiCall(body){
  if(!_apiKey)throw new Error("API key not set. Open Settings and add your Anthropic key.");
  const r=await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",
    headers:{"Content-Type":"application/json","x-api-key":_apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({model:"claude-opus-4-6",...body})
  });
  const d=await r.json();
  if(!r.ok)throw new Error(d.error?.message||"API error");
  return d.content?.[0]?.text||"";
}

// â”€â”€ IMAGE RESIZE â”€â”€
function resizeImage(dataUrl,maxW=2800){
  return new Promise((res,rej)=>{
    if(!dataUrl){return rej(new Error("resizeImage: empty dataUrl"));}
    const img=new Image();
    img.onload=()=>{
      let w=img.width,h=img.height;
      if(w>maxW){h=Math.round(h*(maxW/w));w=maxW;}
      const c=document.createElement("canvas");c.width=w;c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      res(c.toDataURL("image/jpeg",0.75));c.width=0;c.height=0;
    };
    img.onerror=()=>rej(new Error("resizeImage: failed to load image"));
    img.src=dataUrl;
  });
}

// â”€â”€ FIRESTORE â”€â”€
async function saveProject(uid,project){
  const path=_appCtx.projectsPath||`users/${uid}/projects`;
  const col=fbDb.collection(path);
  const ref=project.id?col.doc(project.id):col.doc();
  const data={...project,id:ref.id,updatedAt:Date.now(),...(!project.id&&{createdBy:uid})};
  // Don't store page images in Firestore â€” strip dataUrls from panels
  const stripped={...data,panels:(data.panels||[]).map(panel=>({...panel,pages:(panel.pages||[]).map(p=>{const {dataUrl,...rest}=p;return rest;})}))};
  // Firestore rejects undefined values â€” round-trip through JSON to remove them
  const toSave=JSON.parse(JSON.stringify(stripped));
  await ref.set(toSave);
  return data; // return with dataUrls intact for in-memory use
}
async function loadProjects(uid){
  const path=_appCtx.projectsPath||`users/${uid}/projects`;
  const snap=await fbDb.collection(path).orderBy("updatedAt","desc").get();
  return snap.docs.map(d=>d.data());
}
async function deleteProject(uid,id){
  const path=_appCtx.projectsPath||`users/${uid}/projects`;
  await fbDb.doc(`${path}/${id}`).delete();
}

// â”€â”€ PROJECT MIGRATION (flat â†’ panels) â”€â”€
function migrateProject(p){
  if(p.panels) return p;
  const panel={id:'panel-1',name:'Panel 1',pages:p.pages||[],bom:p.bom||[],validation:p.validation||null,pricing:p.pricing||null,budgetaryQuote:p.budgetaryQuote||null,status:p.status||'draft'};
  const {pages,bom,validation,pricing,budgetaryQuote,...rest}=p;
  return{...rest,panels:[panel]};
}

// â”€â”€ BOM MERGER (combine by partNumber, sum qty) â”€â”€
function mergeBoms(bomArrays){
  const map={};
  bomArrays.flat().forEach(item=>{
    const key=(item.partNumber||"").trim().toLowerCase()||("desc:"+((item.description||"").toLowerCase().slice(0,40)));
    if(map[key]){map[key]={...map[key],qty:(+map[key].qty||1)+(+item.qty||1)};}
    else{map[key]={...item};}
  });
  return Object.values(map);
}

// â”€â”€ FIRESTORE TEAM HELPERS â”€â”€
async function loadUserProfile(uid){
  try{const d=await fbDb.doc(`users/${uid}/config/profile`).get();return d.exists?d.data():null;}catch(e){return null;}
}
async function createCompany(uid,email,name){
  const cid=fbDb.collection("companies").doc().id;
  // Step 1: create the company doc first (rule: createdBy == auth.uid)
  await fbDb.doc(`companies/${cid}`).set({name,createdAt:Date.now(),createdBy:uid});
  // Step 2: now that the company doc exists, write member + profile in a batch
  // (member rule does get() on company to verify createdBy)
  const batch=fbDb.batch();
  batch.set(fbDb.doc(`companies/${cid}/members/${uid}`),{email,role:"admin",addedAt:Date.now()});
  batch.set(fbDb.doc(`users/${uid}/config/profile`),{companyId:cid,role:"admin"});
  await batch.commit();
  return cid;
}
async function loadCompanyMembers(companyId){
  const snap=await fbDb.collection(`companies/${companyId}/members`).get();
  return snap.docs.map(d=>({uid:d.id,...d.data()}));
}
async function loadPendingInvites(companyId){
  const snap=await fbDb.collection(`companies/${companyId}/pendingInvites`).get();
  return snap.docs.map(d=>({token:d.id,...d.data()}));
}

// â”€â”€ FIREBASE CALLABLE WRAPPERS â”€â”€
async function callInviteTeamMember(email,role,companyId){
  return(await fbFunctions.httpsCallable("inviteTeamMember")({email,role,companyId})).data;
}
async function callAcceptTeamInvite(token){
  return(await fbFunctions.httpsCallable("acceptTeamInvite")({token})).data;
}
async function callRemoveTeamMember(targetUid,companyId){
  return(await fbFunctions.httpsCallable("removeTeamMember")({targetUid,companyId})).data;
}
async function callUpdateMemberRole(targetUid,role,companyId){
  return(await fbFunctions.httpsCallable("updateMemberRole")({targetUid,role,companyId})).data;
}

// â”€â”€ BOM EXTRACTION PROMPT â”€â”€
const BOM_PROMPT=`You are reading a page from a UL508A industrial electrical control panel drawing set.
If this page contains a Bill of Materials (BOM) table, extract every line item.
Return ONLY a valid JSON array. Each object must have exactly these fields:
- "qty": number
- "partNumber": string â€” the manufacturer's catalog/model/part number (see rules below)
- "description": string
- "manufacturer": string (brand name only, empty string if not shown)
- "notes": string (ref designators / tags, empty string if none)

STEP 1 â€” IDENTIFY COLUMNS:
Scan the column headers before extracting data. Map each column to the correct field:
â€¢ qty       â†’ columns labeled: QTY, Quantity, Qty.
â€¢ partNumber â†’ columns labeled: "MFG/PART NO.", "MFG/Part No.", "Part No.", "Part #",
               "Cat. No.", "Catalog No.", "Model No.", "Order No.", "Product No.", "Stock No.",
               or any column whose values look like alphanumeric catalog codes (e.g. SCE-24EL20X10SSLP, 1492-A3, 100-C09D10)
â€¢ manufacturer â†’ columns labeled: Manufacturer, MFG, Brand, Make
â€¢ notes     â†’ columns labeled: TAG, Tag No., Ref, Reference, Device ID â€” these contain
               device reference designators (LT1, PB1, M1, CB1, etc.)
â€¢ description â†’ columns labeled: Description, Item Description, Function

STEP 2 â€” EXTRACT RULES:
- NEVER use sequential row/item numbers (1, 2, 3â€¦) as partNumber â€” leave partNumber "" if no catalog number exists
- Values of "---", "â€”", "N/A", or blank in the part number column â†’ partNumber ""
- If the part number column contains a manufacturer prefix before the catalog code
  (e.g. "SAGINAW SCE-24EL20X10SSLP", "ABB AF09-30-10-13"), split them:
  put the brand word(s) in manufacturer and the catalog code in partNumber
- If a cell contains multiple part numbers separated by commas or slashes
  (e.g. "ABB AF09-30-10-13, CA4-22M, TF42-1.0"), put the primary part number in partNumber
  and any additional part numbers in notes
- Reference designator tags (LT1, PB1, M1â€¦) always go in notes, never in partNumber
- Include ALL data rows even if some fields are blank; skip blank trailing rows

General:
- If no BOM table exists on this page, return []
- Do NOT include column headers, totals rows, title blocks, or revision history
- Return the JSON array only â€” no explanation, no markdown`;

async function extractBomPage(dataUrl){
  const b64=dataUrl&&dataUrl.split(",")[1];
  if(!b64){console.warn("extractBomPage: skipping â€” empty or invalid dataUrl");return[];}
  const raw=await apiCall({
    max_tokens:4000,
    messages:[{role:"user",content:[
      {type:"image",source:{type:"base64",media_type:"image/jpeg",data:b64}},
      {type:"text",text:BOM_PROMPT}
    ]}]
  });
  console.log("Claude raw response:",raw);
  try{
    const cleaned=raw.replace(/```json|```/g,"").trim();
    const m=cleaned.match(/\[[\s\S]*\]/);
    if(!m){console.warn("No JSON array found in response");return[];}
    return JSON.parse(m[0]);
  }catch(e){console.error("JSON parse error:",e,raw);return[];}
}

// â”€â”€ SCHEMATIC ANALYSIS PROMPT â”€â”€
const SCHEMATIC_PROMPT=`You are reading a UL508A electrical control panel schematic page.

Extract TWO things and return ONLY valid JSON:
{
  "tags": ["CB100", "M178", ...],
  "wireCount": 42
}

Rules:
- tags: include all alphanumeric device IDs, reference designators, terminal block labels visible on this schematic page
- wireCount: count the number of individual wires (each wire counted once, regardless of how many ends it has)
- Return JSON only, no explanation`;

async function analyzeSchematicPage(dataUrl){
  const b64=dataUrl&&dataUrl.split(",")[1];
  if(!b64){console.warn("analyzeSchematicPage: skipping â€” empty or invalid dataUrl");return{tags:[],wireCount:0};}
  const raw=await apiCall({
    max_tokens:4000,
    messages:[{role:"user",content:[
      {type:"image",source:{type:"base64",media_type:"image/jpeg",data:b64}},
      {type:"text",text:SCHEMATIC_PROMPT}
    ]}]
  });
  console.log("Schematic Claude response:",raw);
  try{
    const cleaned=raw.replace(/```json|```/g,"").trim();
    const m=cleaned.match(/\{[\s\S]*\}/);
    if(!m){console.warn("No JSON object found in schematic response");return{tags:[],wireTerminations:0};}
    const parsed=JSON.parse(m[0]);
    return{tags:Array.isArray(parsed.tags)?parsed.tags:[],wireCount:+parsed.wireCount||0};
  }catch(e){console.error("Schematic JSON parse error:",e,raw);return{tags:[],wireCount:0};}
}

// â”€â”€ PRICING PROMPT â”€â”€
const PRICING_PROMPT=`You are a pricing assistant for industrial electrical control panel components.
Estimate US distributor market prices (Grainger, AutomationDirect, Allied, DigiKey, etc.)
Return ONLY a valid JSON array, same order as input:
[{"id":"...","unitPrice":12.50},...]
Use null for any item you cannot price. No explanation, JSON only.

Items:`;

async function estimatePrices(items){
  const BATCH=20;
  const result={};
  for(let i=0;i<items.length;i+=BATCH){
    const batch=items.slice(i,i+BATCH);
    const payload=batch.map(r=>({id:String(r.id),partNumber:r.partNumber||"",description:r.description||"",manufacturer:r.manufacturer||""}));
    try{
      const raw=await apiCall({
        max_tokens:2000,
        messages:[{role:"user",content:`${PRICING_PROMPT}\n${JSON.stringify(payload)}`}]
      });
      const cleaned=raw.replace(/```json|```/g,"").trim();
      const m=cleaned.match(/\[[\s\S]*\]/);
      if(m){
        const arr=JSON.parse(m[0]);
        arr.forEach(r=>{result[r.id]=r.unitPrice??null;});
      }
    }catch(e){console.error("Pricing batch error:",e);}
  }
  return result;
}

// â”€â”€ COMPONENTS â”€â”€

function Badge({status}){
  const map={
    draft:[C.border,C.muted,"Draft"],
    extracted:[C.greenDim,C.green,"Extracted"],
    validated:[C.accentDim,C.accent,"Validated"],
    quoted:[C.yellowDim,C.yellow,"Quoted"]
  };
  const [bg,col,label]=map[status]||map.draft;
  return<span style={{background:bg,color:col,borderRadius:20,padding:"2px 10px",fontSize:11,fontWeight:700,letterSpacing:0.5,whiteSpace:"nowrap"}}>{label.toUpperCase()}</span>;
}

function PageTypePill({type,onChange}){
  const order=["untagged","bom","schematic","layout"];
  const colors={untagged:C.muted,bom:C.accent,schematic:C.green,layout:C.purple};
  const labels={untagged:"Untagged",bom:"BOM",schematic:"Schematic",layout:"Layout"};
  const next=order[(order.indexOf(type)+1)%order.length];
  return(
    <button onClick={()=>onChange(next)} style={{background:colors[type]+"22",color:colors[type],border:`1px solid ${colors[type]}55`,borderRadius:20,padding:"3px 10px",fontSize:11,fontWeight:700,cursor:"pointer"}}>
      {labels[type]}
    </button>
  );
}

// â”€â”€ PRICING CONFIG MODAL â”€â”€
function PricingConfigModal({uid,onClose}){
  const [bomVal,setBomVal]=useState(_pricingConfig.contingencyBOM);
  const [consVal,setConsVal]=useState(_pricingConfig.contingencyConsumables);
  const [budgPct,setBudgPct]=useState(_pricingConfig.budgetaryContingencyPct??20);
  const [saving,setSaving]=useState(false);
  const [saved,setSaved]=useState(false);

  async function save(){
    setSaving(true);
    await savePricingConfig(uid,{contingencyBOM:bomVal,contingencyConsumables:consVal,budgetaryContingencyPct:budgPct});
    setSaving(false);setSaved(true);setTimeout(()=>setSaved(false),2000);
  }

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div style={{...card(),width:"100%",maxWidth:420}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>âš™ Pricing Configuration</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:20}}>Default contingencies applied when opening a new project</div>
        {[
          ["BOM Contingency","Default amount added to every quote for miscellaneous BOM items","$",bomVal,setBomVal,"number","50"],
          ["Wire / Zip Ties / etc.","Default amount for consumables (wire, zip ties, sticky backs, etc.)","$",consVal,setConsVal,"number","50"],
        ].map(([label,desc,prefix,val,setter,type,step])=>(
          <div key={label} style={{marginBottom:16}}>
            <label style={{fontSize:12,color:C.sub,display:"block",marginBottom:4,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5}}>{label}</label>
            <div style={{display:"flex",alignItems:"center",gap:6}}>
              <span style={{color:C.muted,fontSize:14}}>{prefix}</span>
              <input type={type} min="0" step={step} value={val} onChange={e=>setter(Math.max(0,+e.target.value||0))} style={{...inp(),width:140,textAlign:"right"}}/>
            </div>
            <div style={{fontSize:11,color:C.muted,marginTop:4}}>{desc}</div>
          </div>
        ))}
        <div style={{marginBottom:16}}>
          <label style={{fontSize:12,color:C.sub,display:"block",marginBottom:4,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5}}>Budgetary Contingency %</label>
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <input type="number" min="0" max="100" step="1" value={budgPct} onChange={e=>setBudgPct(Math.max(0,+e.target.value||0))} style={{...inp(),width:140,textAlign:"right"}}/>
            <span style={{color:C.muted,fontSize:14}}>%</span>
          </div>
          <div style={{fontSize:11,color:C.muted,marginTop:4}}>Hidden buffer added to budgetary sell price (default 20%)</div>
        </div>
        <div style={{display:"flex",gap:10,marginTop:4}}>
          <button onClick={onClose} style={btn(C.border,C.sub,{flex:1})}>Cancel</button>
          <button onClick={save} disabled={saving} style={btn(saved?C.green:C.accent,"#fff",{flex:2,opacity:saving?0.6:1})}>
            {saving?"Savingâ€¦":saved?"âœ“ Saved":"Save Defaults"}
          </button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ COMPANY SETUP MODAL â”€â”€
function CompanySetupModal({uid,email,onDone,onClose}){
  const [name,setName]=useState("");
  const [loading,setLoading]=useState(false);
  const [err,setErr]=useState("");

  async function create(e){
    e.preventDefault();if(!name.trim())return;setLoading(true);setErr("");
    try{
      const cid=await createCompany(uid,email,name.trim());
      _appCtx.companyId=cid;_appCtx.role="admin";
      _appCtx.projectsPath=`companies/${cid}/projects`;
      _appCtx.configPath=`companies/${cid}/config`;
      onDone(cid,"admin",name.trim());
    }catch(ex){setErr(ex.message);setLoading(false);}
  }

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div style={{...card(),width:"100%",maxWidth:440}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:20,fontWeight:700,marginBottom:4}}>Set Up Company Workspace</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:20}}>Create a shared workspace so your team can collaborate on projects.</div>
        <form onSubmit={create}>
          <label style={{fontSize:12,color:C.sub,display:"block",marginBottom:6,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5}}>Company Name</label>
          <input value={name} onChange={e=>setName(e.target.value)} placeholder="e.g. Matrix Systems, Inc." style={{...inp(),marginBottom:16}} autoFocus/>
          {err&&<div style={{color:C.red,fontSize:12,marginBottom:12}}>{err}</div>}
          <div style={{display:"flex",gap:10}}>
            <button type="button" onClick={onClose} style={btn(C.border,C.sub,{flex:1})}>Cancel</button>
            <button type="submit" disabled={!name.trim()||loading} style={btn(C.accent,"#fff",{flex:2,opacity:!name.trim()||loading?0.5:1})}>
              {loading?"Creatingâ€¦":"Create Company"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// â”€â”€ REMOVE MEMBER MODAL â”€â”€
function RemoveMemberModal({uid,companyId,member,members,onRemoved,onClose}){
  const [transferTo,setTransferTo]=useState("");
  const [memberProjects,setMemberProjects]=useState([]);
  const [loadingProjects,setLoadingProjects]=useState(true);
  const [removing,setRemoving]=useState(false);
  const [err,setErr]=useState("");

  useEffect(()=>{
    fbDb.collection(`companies/${companyId}/projects`)
      .where("createdBy","==",member.uid)
      .get()
      .then(snap=>{setMemberProjects(snap.docs.map(d=>d.data()));setLoadingProjects(false);})
      .catch(()=>setLoadingProjects(false));
  },[]);

  async function doRemove(){
    setRemoving(true);setErr("");
    try{
      if(transferTo&&memberProjects.length>0){
        const batch=fbDb.batch();
        memberProjects.forEach(p=>{
          batch.update(fbDb.doc(`companies/${companyId}/projects/${p.id}`),{
            transferred:true,
            transferredTo:transferTo,
            transferredFrom:{uid:member.uid,email:member.email},
            createdBy:transferTo,
          });
        });
        await batch.commit();
      }
      await fbFunctions.httpsCallable("removeTeamMember")({targetUid:member.uid,companyId});
      onRemoved(member.uid);
    }catch(ex){setErr(ex.message);}
    setRemoving(false);
  }

  const recipients=members.filter(m=>m.uid!==member.uid);
  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:400,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div style={{...card(),width:"100%",maxWidth:480}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Remove Member</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:20}}>Removing <strong style={{color:C.text}}>{member.email}</strong> from the workspace.</div>
        {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:8,padding:10,marginBottom:12,fontSize:13,color:C.red}}>{err}</div>}
        {loadingProjects?(
          <div style={{color:C.muted,fontSize:13,padding:"20px 0",textAlign:"center"}}>Checking projectsâ€¦</div>
        ):(
          <>
            {memberProjects.length>0?(
              <div style={{marginBottom:20}}>
                <div style={{fontSize:12,color:C.sub,fontWeight:700,textTransform:"uppercase",letterSpacing:0.5,marginBottom:10}}>Their Projects ({memberProjects.length})</div>
                <div style={{background:"#0a0a12",borderRadius:8,padding:10,marginBottom:14,maxHeight:130,overflow:"auto"}}>
                  {memberProjects.map(p=>(
                    <div key={p.id} style={{fontSize:13,color:C.text,padding:"5px 0",borderBottom:`1px solid ${C.border}22`}}>{p.name}</div>
                  ))}
                </div>
                <div style={{fontSize:13,color:C.sub,marginBottom:8}}>Transfer projects to:</div>
                <select value={transferTo} onChange={e=>setTransferTo(e.target.value)}
                  style={{width:"100%",background:"#0a0a12",border:`1px solid ${C.border}`,borderRadius:8,padding:"9px 12px",color:transferTo?C.text:C.muted,fontSize:14,marginBottom:6}}>
                  <option value="">Leave in workspace (no specific owner)</option>
                  {recipients.map(m=>(
                    <option key={m.uid} value={m.uid}>{m.email} ({m.role})</option>
                  ))}
                </select>
                {transferTo&&<div style={{fontSize:11,color:C.muted}}>Projects will appear in the recipient's Transferred Projects section.</div>}
              </div>
            ):(
              <div style={{background:"#0a0a12",borderRadius:8,padding:14,marginBottom:20,fontSize:13,color:C.muted}}>This member has no projects.</div>
            )}
            <div style={{display:"flex",gap:10,justifyContent:"flex-end"}}>
              <button onClick={onClose} disabled={removing} style={btn(C.border,C.sub)}>Cancel</button>
              <button onClick={doRemove} disabled={removing} style={btn(C.red,"#fff",{opacity:removing?0.6:1})}>
                {removing?"Removingâ€¦":transferTo?"Transfer & Remove":"Remove Member"}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// â”€â”€ TEAM MODAL â”€â”€
function TeamModal({uid,companyId,userRole,onClose}){
  const [members,setMembers]=useState([]);
  const [loading,setLoading]=useState(true);
  const [inviteEmail,setInviteEmail]=useState("");
  const [inviteRole,setInviteRole]=useState("edit");
  const [inviting,setInviting]=useState(false);
  const [generatedLinks,setGeneratedLinks]=useState([]); // [{email,role,url}]
  const [copied,setCopied]=useState("");
  const [err,setErr]=useState("");
  const [removingMember,setRemovingMember]=useState(null);

  useEffect(()=>{
    if(!companyId){setLoading(false);return;}
    loadCompanyMembers(companyId)
      .then(m=>{
        // Ensure the current user always appears; repair missing member doc if needed
        if(!m.some(x=>x.uid===uid)){
          const self={uid,email:fbAuth.currentUser?.email||"",role:userRole};
          fbDb.doc(`companies/${companyId}/members/${uid}`).set(self,{merge:true}).catch(()=>{});
          m=[self,...m];
        }
        setMembers(m);setLoading(false);
      })
      .catch(e=>{setErr("Failed to load members: "+e.message);setLoading(false);});
  },[companyId]);

  async function sendInvite(e){
    e.preventDefault();if(!inviteEmail.trim())return;
    setInviting(true);setErr("");
    try{
      const email=inviteEmail.trim();
      const payload=btoa(JSON.stringify({c:companyId,r:inviteRole,e:email}));
      const url=`${window.location.origin}${window.location.pathname}?join=${payload}`;
      await fbFunctions.httpsCallable("sendInviteEmail")({to:email,inviteUrl:url,role:inviteRole});
      setGeneratedLinks(l=>[...l,{email,role:inviteRole,url,sent:true}]);
      setInviteEmail("");
    }catch(ex){setErr(ex.message);}
    setInviting(false);
  }

  function handleMemberRemoved(targetUid){
    setMembers(m=>m.filter(x=>x.uid!==targetUid));
    setRemovingMember(null);
  }

  async function changeRole(targetUid,role){
    try{
      await fbFunctions.httpsCallable("updateMemberRole")({targetUid,role,companyId});
      setMembers(m=>m.map(x=>x.uid===targetUid?{...x,role}:x));
    }catch(ex){setErr(ex.message);}
  }

  const admin=userRole==="admin";
  const roleBadge={admin:[C.accentDim,C.accent],edit:[C.greenDim,C.green],view:[C.border,C.muted]};

  return(<>
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div style={{...card(),width:"100%",maxWidth:560,maxHeight:"80vh",overflow:"auto"}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>ðŸ‘¥ Team</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:20}}>Manage company workspace members</div>
        {loading&&<div style={{color:C.muted,fontSize:13,padding:"20px 0",textAlign:"center"}}>Loadingâ€¦</div>}
        {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:8,padding:10,marginBottom:12,fontSize:13,color:C.red}}>{err}</div>}

        {!loading&&(
          <>
            {/* Members */}
            <div style={{marginBottom:20}}>
              <div style={{fontSize:12,color:C.sub,fontWeight:700,textTransform:"uppercase",letterSpacing:0.5,marginBottom:10}}>Members ({members.length})</div>
              {members.map(m=>{
                const [bg,col]=roleBadge[m.role]||roleBadge.view;
                return(
                  <div key={m.uid} style={{display:"flex",alignItems:"center",gap:10,marginBottom:8,padding:"8px 12px",background:"#0a0a12",borderRadius:8}}>
                    <div style={{flex:1,fontSize:13,color:C.text}}>{m.email}</div>
                    {admin&&m.uid!==uid?(
                      <select value={m.role} onChange={e=>changeRole(m.uid,e.target.value)}
                        style={{background:C.card,color:C.text,border:`1px solid ${C.border}`,borderRadius:6,padding:"4px 8px",fontSize:12,cursor:"pointer"}}>
                        <option value="admin">admin</option>
                        <option value="edit">edit</option>
                        <option value="view">view</option>
                      </select>
                    ):(
                      <span style={{background:bg,color:col,borderRadius:10,padding:"2px 10px",fontSize:11,fontWeight:700}}>{m.role}</span>
                    )}
                    {admin&&m.uid!==uid&&(
                      <button onClick={()=>setRemovingMember(m)} style={{background:C.redDim,color:C.red,border:"none",borderRadius:6,padding:"4px 8px",fontSize:12,cursor:"pointer"}}>Remove</button>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Generated invite links (this session) */}
            {generatedLinks.length>0&&(
              <div style={{marginBottom:20}}>
                <div style={{fontSize:12,color:C.sub,fontWeight:700,textTransform:"uppercase",letterSpacing:0.5,marginBottom:10}}>Invite Links</div>
                {generatedLinks.map((inv,i)=>(
                  <div key={i} style={{marginBottom:8,padding:"8px 12px",background:"#0a0a12",borderRadius:8}}>
                    <div style={{display:"flex",alignItems:"center",gap:10}}>
                      <div style={{flex:1,fontSize:13,color:C.text}}>{inv.email}</div>
                      <span style={{background:C.yellowDim,color:C.yellow,borderRadius:10,padding:"2px 10px",fontSize:11,fontWeight:700,whiteSpace:"nowrap"}}>{inv.role}</span>
                      {inv.sent&&<span style={{color:C.green,fontSize:11,fontWeight:700}}>âœ“ Email sent</span>}
                      <button
                        onClick={()=>{navigator.clipboard.writeText(inv.url);setCopied(i);setTimeout(()=>setCopied(""),2000);}}
                        style={btn(copied===i?C.greenDim:C.border,copied===i?C.green:C.muted,{fontSize:11,padding:"3px 10px"})}>
                        {copied===i?"âœ“ Copied":"Copy Link"}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Invite form â€” admin only */}
            {admin&&(
              <div>
                <div style={{fontSize:12,color:C.sub,fontWeight:700,textTransform:"uppercase",letterSpacing:0.5,marginBottom:10}}>Invite Member</div>
                <form onSubmit={sendInvite}>
                  <div style={{display:"flex",gap:8,marginBottom:8,flexWrap:"wrap"}}>
                    <input value={inviteEmail} onChange={e=>setInviteEmail(e.target.value)} type="email" placeholder="email@company.com" style={{...inp(),flex:"2 1 180px"}}/>
                    <select value={inviteRole} onChange={e=>setInviteRole(e.target.value)}
                      style={{background:"#0a0a12",border:`1px solid ${C.border}`,borderRadius:8,padding:"9px 12px",color:C.text,fontSize:14}}>
                      <option value="admin">Admin</option>
                      <option value="edit">Edit</option>
                      <option value="view">View</option>
                    </select>
                    <button type="submit" disabled={!inviteEmail.trim()||inviting} style={btn(C.accent,"#fff",{opacity:!inviteEmail.trim()||inviting?0.5:1})}>
                      {inviting?"Sendingâ€¦":"Send Invite"}
                    </button>
                  </div>
                  <div style={{fontSize:11,color:C.muted,marginTop:4}}>Sends an invite email automatically. Link also appears below if you need to share it manually.</div>
                </form>
              </div>
            )}
          </>
        )}

        <div style={{marginTop:20,display:"flex",justifyContent:"flex-end"}}>
          <button onClick={onClose} style={btn(C.border,C.sub)}>Close</button>
        </div>
      </div>
    </div>
    {removingMember&&(
      <RemoveMemberModal
        uid={uid} companyId={companyId} member={removingMember} members={members}
        onRemoved={handleMemberRemoved} onClose={()=>setRemovingMember(null)}/>
    )}
  </>);
}

// â”€â”€ LOGIN â”€â”€
function LoginScreen({invite}){
  const [email,setEmail]=useState(invite?.e||"");
  const [pass,setPass]=useState("");
  const [mode,setMode]=useState(invite?"register":"login");
  const [err,setErr]=useState("");
  const [loading,setLoading]=useState(false);
  const [resetSent,setResetSent]=useState(false);
  const emailRef=useRef(null);

  async function submit(e){
    e.preventDefault();setErr("");setLoading(true);
    try{
      if(mode==="login")await fbAuth.signInWithEmailAndPassword(email,pass);
      else await fbAuth.createUserWithEmailAndPassword(email,pass);
    }catch(ex){
      if(ex.code==="auth/email-already-in-use"){
        setMode("login");
        setErr("That email already has an account â€” sign in below, or use Forgot Password to reset it.");
      } else if(["auth/user-not-found","auth/wrong-password","auth/invalid-credential","auth/invalid-email"].includes(ex.code)){
        setErr("Email or password not recognized. Please try again, or use Forgot Password to reset it.");
      } else {
        setErr(ex.message);
      }
    }
    setLoading(false);
  }
  async function google(){
    setLoading(true);
    try{await fbAuth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}
    catch(ex){setErr(ex.message);}
    setLoading(false);
  }
  async function microsoft(){
    setLoading(true);
    try{
      const provider=new firebase.auth.OAuthProvider("microsoft.com");
      provider.setCustomParameters({prompt:"select_account"});
      await fbAuth.signInWithPopup(provider);
    }catch(ex){
      if(ex.code==="auth/account-exists-with-different-credential"){
        if(ex.email)setEmail(ex.email);
        setErr("An account with this email already exists â€” please sign in with your email and password below.");
      } else {
        setErr(ex.message);
      }
    }
    setLoading(false);
  }
  async function sendReset(e){
    e.preventDefault();setErr("");setLoading(true);
    try{
      await fbAuth.sendPasswordResetEmail(email);
      setResetSent(true);
    }catch(ex){setErr(ex.message);}
    setLoading(false);
  }
  function switchMode(m){
    // Capture actual DOM value first â€” browser autocomplete may not fire onChange
    if(emailRef.current)setEmail(emailRef.current.value);
    setMode(m);setErr("");setResetSent(false);
  }

  return(
    <div style={{minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:`radial-gradient(ellipse at 50% 0%,#1a1a3e 0%,${C.bg} 60%)`}}>
      <div style={{textAlign:"center",marginBottom:32}}>
        <div style={{fontSize:52,marginBottom:10}}>â¬¡</div>
        <div style={{fontSize:34,fontWeight:800,letterSpacing:-1}}>Matrix <span style={{color:C.accent}}>ARC</span></div>
        <div style={{fontSize:14,color:C.muted,marginTop:6}}>AI Recognition &amp; Capture Â· Control Panel Quoting</div>
      </div>
      {invite&&(
        <div style={{background:C.accentDim,border:`1px solid ${C.accent}44`,borderRadius:12,padding:"14px 20px",marginBottom:20,textAlign:"center",width:"100%",maxWidth:400}}>
          <div style={{fontSize:15,fontWeight:700,color:C.accent,marginBottom:4}}>You've been invited to Matrix ARC</div>
          <div style={{fontSize:13,color:C.sub}}>Create an account or sign in to join your team workspace.</div>
        </div>
      )}
      <div style={{...card(),width:"100%",maxWidth:400}}>
        {mode==="reset"?(
          resetSent?(
            <div>
              <div style={{fontSize:18,fontWeight:700,marginBottom:12}}>Check your email</div>
              <div style={{fontSize:13,color:C.muted,marginBottom:20,lineHeight:1.6}}>A password reset link was sent to <strong style={{color:C.fg}}>{email}</strong>. Check your inbox and follow the link to set a new password.</div>
              <button onClick={()=>switchMode("login")} style={btn(C.accent,"#fff",{width:"100%"})}>Back to Sign In</button>
            </div>
          ):(
            <div>
              <div style={{fontSize:18,fontWeight:700,marginBottom:6}}>Reset Password</div>
              <div style={{fontSize:13,color:C.muted,marginBottom:16}}>Enter your email and we'll send a reset link.</div>
              <form onSubmit={sendReset}>
                <div style={{marginBottom:16}}><input value={email} onChange={e=>setEmail(e.target.value)} type="email" placeholder="Email" style={inp()} required/></div>
                {err&&<div style={{color:C.red,fontSize:12,marginBottom:12,lineHeight:1.5}}>{err}</div>}
                <button type="submit" disabled={loading} style={btn(C.accent,"#fff",{width:"100%",opacity:loading?0.6:1})}>{loading?"Sendingâ€¦":"Send Reset Link"}</button>
              </form>
              <div style={{textAlign:"center",marginTop:14,fontSize:12,color:C.muted}}>
                <button onClick={()=>switchMode("login")} style={{background:"none",border:"none",color:C.accent,cursor:"pointer",fontWeight:600,fontSize:12}}>Back to Sign In</button>
              </div>
            </div>
          )
        ):(
          <div>
            <div style={{fontSize:18,fontWeight:700,marginBottom:20}}>{mode==="login"?"Sign In":"Create Account"}</div>
            <form onSubmit={submit}>
              <div style={{marginBottom:10}}><input ref={emailRef} value={email} onChange={e=>setEmail(e.target.value)} type="email" placeholder="Email" style={inp()} required/></div>
              <div style={{marginBottom:6}}><input value={pass} onChange={e=>setPass(e.target.value)} type="password" placeholder="Password" style={inp()} required/></div>
              <div style={{textAlign:"right",marginBottom:14}}>
                <button type="button" onClick={()=>switchMode("reset")} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:12}}>Forgot password?</button>
              </div>
              {err&&<div style={{color:C.red,fontSize:12,marginBottom:12,lineHeight:1.5}}>{err}</div>}
              <button type="submit" disabled={loading} style={btn(C.accent,"#fff",{width:"100%",opacity:loading?0.6:1})}>{loading?"Please waitâ€¦":mode==="login"?"Sign In":"Create Account"}</button>
            </form>
            <div style={{textAlign:"center",margin:"14px 0",color:C.muted,fontSize:12}}>or</div>
            <div style={{display:"flex",flexDirection:"column",gap:8}}>
              <button onClick={google} disabled={loading} style={btn("#fff","#1a1a1a",{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8})}>
                <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                Continue with Google
              </button>
              <button onClick={microsoft} disabled={loading} style={btn("#2f2f2f","#fff",{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8})}>
                <svg width="16" height="16" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
                Continue with Microsoft
              </button>
            </div>
            <div style={{textAlign:"center",marginTop:14,fontSize:12,color:C.muted}}>
              {mode==="login"?"No account? ":"Have an account? "}
              <button onClick={()=>switchMode(mode==="login"?"register":"login")} style={{background:"none",border:"none",color:C.accent,cursor:"pointer",fontWeight:600,fontSize:12}}>
                {mode==="login"?"Register":"Sign In"}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€ FAST QUOTE OVERLAY â”€â”€
function FastQuoteOverlay({project,uid,onUpdate,onSaveImmediate,onClose,onDone}){
  const [progress,setProgress]=useState(0);
  const [stepLabel,setStepLabel]=useState("Startingâ€¦");
  const [status,setStatus]=useState("running"); // running | done | error
  const [err,setErr]=useState("");

  useEffect(()=>{
    let cancelled=false;
    (async()=>{
      try{
        let proj={...project};

        // Step 1: Extract BOM (0â€“33%)
        setStepLabel("Extracting BOMâ€¦");
        const bomPages=(proj.pages||[]).filter(p=>p.type==="bom");
        let all=[];
        for(let i=0;i<bomPages.length;i++){
          if(cancelled)return;
          const pg=bomPages[i];
          if(!pg.dataUrl)continue;
          setProgress(Math.round((i/Math.max(bomPages.length,1))*33));
          const items=await extractBomPage(pg.dataUrl);
          all=[...all,...items];
        }
        // Dedup by part number
        const map={};
        all.forEach(item=>{
          const key=(item.partNumber||"").trim().toLowerCase()||("desc:"+item.description.toLowerCase().slice(0,40));
          if(map[key]){map[key].qty=(+map[key].qty||1)+(+item.qty||1);}
          else{map[key]={...item,id:Date.now()+Math.random(),qty:+item.qty||1};}
        });
        const bom=all.length?Object.values(map):(proj.bom||[]);
        proj={...proj,bom,status:"extracted"};
        setProgress(33);

        // Step 2: Validate schematics (33â€“66%)
        setStepLabel("Analyzing schematicsâ€¦");
        const schPages=(proj.pages||[]).filter(p=>p.type==="schematic");
        let allTags=[];let totalWires=0;
        for(let i=0;i<schPages.length;i++){
          if(cancelled)return;
          const pg=schPages[i];
          if(!pg.dataUrl)continue;
          setProgress(33+Math.round((i/Math.max(schPages.length,1))*33));
          const result=await analyzeSchematicPage(pg.dataUrl);
          allTags=[...allTags,...result.tags];
          totalWires+=result.wireCount;
        }
        const schematicTags=[...new Set(allTags.map(t=>t.trim()).filter(Boolean))];
        const validation={runAt:Date.now(),schematicTags,wireCount:totalWires,matched:[],missingFromSchematic:[],notTraceable:[],unaccountedTags:[],confidence:"medium"};
        proj={...proj,validation,status:"validated"};
        setProgress(66);

        // Step 3: Price BOM (66â€“90%)
        setStepLabel("Estimating pricesâ€¦");
        if(proj.bom&&proj.bom.length){
          const priceMap=await estimatePrices(proj.bom);
          const pricedBom=proj.bom.map(r=>{
            const key=String(r.id);
            if(key in priceMap)return{...r,unitPrice:priceMap[key],priceSource:priceMap[key]!=null?"ai":null};
            return r;
          });
          proj={...proj,bom:pricedBom};
        }
        setProgress(90);

        // Step 4: Budgetary quote calculation (90â€“100%)
        setStepLabel("Computing budgetary estimateâ€¦");
        const pr=proj.pricing||{};
        const currentBom=proj.bom||[];
        const totalCost=currentBom.reduce((s,r)=>s+(r.unitPrice||0)*(r.qty||1),0);
        const wireCount=proj.validation?.wireCount||0;
        const defaultHours=wireCount?Math.round((Math.ceil(wireCount/12)+Math.ceil(wireCount/8))/2):0;
        const laborRate=pr.laborRate??45;
        const contingencyBOM=pr.contingencyBOM??_pricingConfig.contingencyBOM;
        const contingencyConsumables=pr.contingencyConsumables??_pricingConfig.contingencyConsumables;
        const grandTotal=totalCost+defaultHours*laborRate+contingencyBOM+contingencyConsumables;
        const budgetaryPct=pr.budgetaryContingencyPct??_pricingConfig.budgetaryContingencyPct??20;
        const markup=pr.markup??30;
        const budgetarySellPrice=grandTotal*(1+budgetaryPct/100)*(1+markup/100);
        proj={...proj,budgetaryQuote:{generatedAt:Date.now(),contingencyPct:budgetaryPct,baseGrandTotal:grandTotal,budgetarySellPrice}};

        if(cancelled)return;
        setProgress(97);
        if(onSaveImmediate){await onSaveImmediate(proj);}else{await saveProject(uid,proj);}
        onUpdate(proj);
        setProgress(100);
        setStepLabel("Complete!");
        setStatus("done");
        setTimeout(()=>onDone("quote"),900);
      }catch(ex){
        setErr(ex.message);
        setStatus("error");
      }
    })();
    return()=>{cancelled=true;};
  },[]);

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.92)",zIndex:400,display:"flex",alignItems:"center",justifyContent:"center",padding:24}}>
      <div style={{...card(),width:"100%",maxWidth:480,textAlign:"center"}}>
        <div style={{fontSize:40,marginBottom:12}}>âš¡</div>
        <div style={{fontSize:20,fontWeight:700,marginBottom:4}}>Fast Quote</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:24}}>Running full pipeline: Extract â†’ Validate â†’ Price â†’ Budgetary Quote</div>
        <div style={{background:C.border,borderRadius:4,height:8,overflow:"hidden",marginBottom:12}}>
          <div style={{width:`${progress}%`,height:"100%",background:status==="error"?C.red:C.yellow,borderRadius:4,transition:"width 0.4s"}}/>
        </div>
        <div style={{fontSize:13,color:C.sub,minHeight:20,marginBottom:status==="error"?16:0}}>
          {status==="done"?"âœ“ Complete â€” opening Budgetary Quoteâ€¦":status==="error"?"":stepLabel}
        </div>
        {err&&(
          <div style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:8,padding:12,marginBottom:16,fontSize:13,color:C.red,textAlign:"left"}}>{err}</div>
        )}
        {status==="error"&&(
          <button onClick={onClose} style={btn(C.border,C.sub)}>Close</button>
        )}
      </div>
    </div>
  );
}

// â”€â”€ DRAWINGS TAB â”€â”€
function DrawingsTab({project,uid,onUpdate,onSaveImmediate,readOnly,onNavigateTab}){
  const [dragging,setDragging]=useState(false);
  const [processing,setProcessing]=useState(false);
  const [pendingFiles,setPendingFiles]=useState(null);
  const [showFastQuote,setShowFastQuote]=useState(false);
  const fileRef=useRef(null);

  const pages=project.pages||[];
  const nextLineItemNum=Math.max(0,...pages.map(p=>p.lineItem||0))+1;

  async function addFiles(files,lineItem){
    setProcessing(true);
    const items=[];
    for(const f of Array.from(files)){
      if(f.type==="application/pdf"){
        await window.pdfjsReady;
        const pdfjs=window._pdfjs;
        const buf=await f.arrayBuffer();
        const pdf=await pdfjs.getDocument({data:buf}).promise;
        for(let pg=1;pg<=pdf.numPages;pg++){
          const page=await pdf.getPage(pg);
          const vp=page.getViewport({scale:3.0});
          const canvas=document.createElement("canvas");
          canvas.width=vp.width;canvas.height=vp.height;
          await page.render({canvasContext:canvas.getContext("2d"),viewport:vp}).promise;
          const dataUrl=canvas.toDataURL("image/jpeg",0.95);
          canvas.width=0;canvas.height=0;
          const resized=await resizeImage(dataUrl,2800);
          items.push({id:Date.now()+Math.random(),name:`${f.name} â€” p${pg}`,dataUrl:resized,type:"untagged",lineItem:lineItem||null});
        }
      } else if(f.type.startsWith("image/")){
        const reader=new FileReader();
        const dataUrl=await new Promise(r=>{reader.onload=e=>r(e.target.result);reader.readAsDataURL(f);});
        const resized=await resizeImage(dataUrl,1400);
        items.push({id:Date.now()+Math.random(),name:f.name,dataUrl:resized,type:"untagged",lineItem:lineItem||null});
      }
    }
    onUpdate({...project,pages:[...(project.pages||[]),...items]});
    setProcessing(false);
  }

  function stageFiles(files){setPendingFiles(files);}
  function confirmLineItem(one){
    const f=pendingFiles;setPendingFiles(null);
    addFiles(f,one?nextLineItemNum:null);
  }

  function drop(e){e.preventDefault();setDragging(false);stageFiles(e.dataTransfer.files);}
  function tagPage(id,type){onUpdate({...project,pages:project.pages.map(p=>p.id===id?{...p,type}:p)});}
  function removePage(id){onUpdate({...project,pages:project.pages.filter(p=>p.id!==id)});}
  function movePage(id,dir){
    const arr=[...(project.pages||[])];
    const i=arr.findIndex(p=>p.id===id);const ni=i+dir;
    if(ni<0||ni>=arr.length)return;
    [arr[i],arr[ni]]=[arr[ni],arr[i]];
    onUpdate({...project,pages:arr});
  }

  const counts={bom:pages.filter(p=>p.type==="bom").length,schematic:pages.filter(p=>p.type==="schematic").length,layout:pages.filter(p=>p.type==="layout").length};

  // Build display groups: numbered line items in order, then ungrouped
  const lineItemNums=[...new Set(pages.map(p=>p.lineItem).filter(Boolean))].sort((a,b)=>a-b);
  const ungrouped=pages.filter(p=>!p.lineItem);

  function PageCard({p,allPages}){
    const i=allPages.findIndex(x=>x.id===p.id);
    return(
      <div key={p.id} className="fade-in" style={{...card({padding:10})}}>
        <img src={p.dataUrl} alt={p.name} style={{width:"100%",aspectRatio:"8.5/11",objectFit:"cover",borderRadius:6,marginBottom:8,background:"#080810"}}/>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
          <PageTypePill type={p.type} onChange={t=>tagPage(p.id,t)}/>
          <div style={{display:"flex",gap:3}}>
            {i>0&&<button onClick={()=>movePage(p.id,-1)} style={{background:C.border,color:C.muted,border:"none",borderRadius:4,padding:"2px 6px",cursor:"pointer",fontSize:11}}>â†‘</button>}
            {i<allPages.length-1&&<button onClick={()=>movePage(p.id,1)} style={{background:C.border,color:C.muted,border:"none",borderRadius:4,padding:"2px 6px",cursor:"pointer",fontSize:11}}>â†“</button>}
            <button onClick={()=>removePage(p.id)} style={{background:C.redDim,color:C.red,border:"none",borderRadius:4,padding:"2px 6px",cursor:"pointer",fontSize:11}}>âœ•</button>
          </div>
        </div>
        <div style={{fontSize:11,color:C.muted,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.name}</div>
      </div>
    );
  }

  return(
    <div>
      <div style={{display:"flex",gap:12,marginBottom:20,flexWrap:"wrap"}}>
        {[["ðŸ“„",pages.length,"Total"],["ðŸ“‹",counts.bom,"BOM"],["ðŸ“",counts.schematic,"Schematic"],["ðŸ—‚ï¸",counts.layout,"Layout"]].map(([icon,n,label])=>(
          <div key={label} style={{...card({padding:"12px 16px"}),display:"flex",alignItems:"center",gap:10,minWidth:110}}>
            <span style={{fontSize:22}}>{icon}</span>
            <div><div style={{fontSize:22,fontWeight:800,color:C.accent}}>{n}</div><div style={{fontSize:11,color:C.muted}}>{label}</div></div>
          </div>
        ))}
      </div>

      <div
        onDragOver={e=>{e.preventDefault();setDragging(true);}}
        onDragLeave={()=>setDragging(false)}
        onDrop={drop}
        onClick={()=>!pendingFiles&&!processing&&fileRef.current?.click()}
        style={{border:`2px dashed ${dragging?C.accent:C.border}`,borderRadius:12,padding:36,textAlign:"center",marginBottom:20,cursor:pendingFiles||processing?"default":"pointer",transition:"all 0.15s",background:dragging?C.accentDim+"33":"transparent"}}>
        <input ref={fileRef} type="file" multiple accept="image/*,application/pdf" onChange={e=>{stageFiles(e.target.files);e.target.value="";}} style={{display:"none"}}/>
        <div style={{fontSize:40,marginBottom:10,opacity:0.6}}>{processing?"â³":"ðŸ“„"}</div>
        <div style={{fontSize:15,fontWeight:600,color:C.sub,marginBottom:6}}>{processing?"Processing pagesâ€¦":"Drop drawings here"}</div>
        <div style={{fontSize:13,color:C.muted}}>{processing?"Converting PDF pages to images, please waitâ€¦":"or click to browse Â· PDF, JPG, PNG supported Â· multi-page PDFs auto-split"}</div>
      </div>

      {/* Line item prompt */}
      {pendingFiles&&(
        <div style={{...card({padding:20}),marginBottom:20,borderColor:C.accent+"66"}} className="fade-in">
          <div style={{fontSize:15,fontWeight:700,marginBottom:4}}>
            ðŸ“„ {pendingFiles.length} file{pendingFiles.length!==1?"s":""} ready to import
          </div>
          <div style={{fontSize:13,color:C.muted,marginBottom:16}}>Are these drawings for one panel (line item) or multiple separate line items?</div>
          <div style={{display:"flex",gap:10,flexWrap:"wrap"}}>
            <button onClick={()=>confirmLineItem(true)} style={btn(C.accent,"#fff",{fontSize:13})}>
              One Line Item â†’ Group as Line Item {nextLineItemNum}
            </button>
            <button onClick={()=>confirmLineItem(false)} style={btn(C.border,C.sub,{fontSize:13})}>
              Multiple Line Items (no grouping)
            </button>
            <button onClick={()=>setPendingFiles(null)} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,padding:"9px 12px"}}>Cancel</button>
          </div>
        </div>
      )}

      {pages.length>0&&(
        <div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:8}}>
            <div style={{fontSize:12,color:C.muted}}>
              Tap each badge to cycle page type: <span style={{color:C.accent}}>BOM</span> Â· <span style={{color:C.green}}>Schematic</span> Â· <span style={{color:C.purple}}>Layout</span> Â· then go to <strong style={{color:C.text}}>Extract</strong>.
            </div>
            {pages.some(p=>p.type==="bom"||p.type==="schematic")&&(
              <button onClick={()=>setShowFastQuote(true)} disabled={readOnly} style={btn(C.yellowDim,C.yellow,{fontSize:13,border:`1px solid ${C.yellow}44`,opacity:readOnly?0.5:1})}>
                âš¡ Fast Quote
              </button>
            )}
          </div>

          {/* Grouped line items */}
          {lineItemNums.map(num=>{
            const group=pages.filter(p=>p.lineItem===num);
            return(
              <div key={num} style={{marginBottom:24}}>
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:12}}>
                  <div style={{height:1,flex:1,background:C.border}}/>
                  <span style={{background:C.accentDim,color:C.accent,borderRadius:20,padding:"3px 14px",fontSize:12,fontWeight:700,whiteSpace:"nowrap"}}>Line Item {num}</span>
                  <div style={{height:1,flex:1,background:C.border}}/>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(190px,1fr))",gap:12}}>
                  {group.map(p=><PageCard key={p.id} p={p} allPages={pages}/>)}
                </div>
              </div>
            );
          })}

          {/* Ungrouped pages */}
          {ungrouped.length>0&&(
            <div>
              {lineItemNums.length>0&&(
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:12}}>
                  <div style={{height:1,flex:1,background:C.border}}/>
                  <span style={{color:C.muted,fontSize:12,fontWeight:600}}>Ungrouped</span>
                  <div style={{height:1,flex:1,background:C.border}}/>
                </div>
              )}
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(190px,1fr))",gap:12}}>
                {ungrouped.map(p=><PageCard key={p.id} p={p} allPages={pages}/>)}
              </div>
            </div>
          )}
        </div>
      )}
      {showFastQuote&&(
        <FastQuoteOverlay
          project={project}
          uid={uid}
          onUpdate={onUpdate}
          onSaveImmediate={onSaveImmediate}
          onClose={()=>setShowFastQuote(false)}
          onDone={tab=>{setShowFastQuote(false);onNavigateTab&&onNavigateTab(tab);}}
        />
      )}
    </div>
  );
}

// â”€â”€ EXTRACT TAB â”€â”€
function ExtractTab({project,uid,onUpdate,onSaveImmediate,readOnly}){
  const [running,setRunning]=useState(false);
  const [progress,setProgress]=useState(null);
  const [err,setErr]=useState("");

  const bomPages=(project.pages||[]).filter(p=>p.type==="bom");

  async function runExtraction(){
    if(!bomPages.length){setErr("No pages tagged as BOM. Tag your BOM pages in the Drawings tab first.");return;}
    setRunning(true);setErr("");setProgress({msg:"Startingâ€¦",pct:5});
    let all=[];
    for(let i=0;i<bomPages.length;i++){
      const pg=bomPages[i];
      if(!pg.dataUrl){setErr(`Page "${pg.name}" has no image data. Please re-upload the PDF.`);setRunning(false);return;}
      setProgress({msg:`Analyzing page ${i+1} of ${bomPages.length}: ${pg.name}â€¦`,pct:10+Math.round((i/bomPages.length)*80)});
      try{const items=await extractBomPage(pg.dataUrl);all=[...all,...items];}
      catch(ex){setErr(`Failed on ${pg.name}: ${ex.message}`);setRunning(false);return;}
      setProgress({msg:`Page ${i+1} of ${bomPages.length} done â€” ${all.length} items so far`,pct:10+Math.round(((i+1)/bomPages.length)*80)});
    }
    setProgress({msg:"Merging duplicatesâ€¦",pct:95});
    // Deduplicate: group by partNumber, sum qty
    const map={};
    all.forEach(item=>{
      const key=(item.partNumber||"").trim().toLowerCase()||("desc:"+item.description.toLowerCase().slice(0,40));
      if(map[key]){map[key].qty=(+map[key].qty||1)+(+item.qty||1);}
      else{map[key]={...item,id:Date.now()+Math.random(),qty:+item.qty||1};}
    });
    const bom=Object.values(map);
    const updated={...project,bom,status:"extracted",updatedAt:Date.now()};
    setProgress({msg:"Saving resultsâ€¦",pct:97});
    if(onSaveImmediate){try{await onSaveImmediate(updated);}catch(ex){setErr(`Save failed: ${ex.message}`);}}
    else{try{await saveProject(uid,updated);}catch(ex){setErr(`Save failed: ${ex.message}`);}}
    onUpdate(updated);
    setProgress({msg:`Complete â€” ${bom.length} unique items extracted.`,pct:100});
    setRunning(false);
  }

  function updateRow(id,field,val){
    onUpdate({...project,bom:project.bom.map(r=>r.id===id?{...r,[field]:val}:r)});
  }
  function addRow(){
    onUpdate({...project,bom:[...(project.bom||[]),{id:Date.now(),qty:1,partNumber:"",description:"",manufacturer:"",notes:""}]});
  }
  function deleteRow(id){
    onUpdate({...project,bom:project.bom.filter(r=>r.id!==id)});
  }
  function exportCSV(){
    const header=["Qty","Part Number","Description","Manufacturer","Notes"];
    const rows=[header,...(project.bom||[]).map(r=>[r.qty,r.partNumber,r.description,r.manufacturer,r.notes])];
    const csv=rows.map(r=>r.map(c=>`"${String(c||"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const a=document.createElement("a");
    a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
    a.download=`${(project.name||"BOM").replace(/[^a-z0-9]/gi,"_")}_BOM.csv`;
    a.click();
  }

  const bom=project.bom||[];

  return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:20,flexWrap:"wrap",gap:12}}>
        <div>
          <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>BOM Extraction</div>
          <div style={{fontSize:13,color:C.muted}}>{bomPages.length} BOM page{bomPages.length!==1?"s":""} tagged Â· {bom.length} items in table</div>
        </div>
        <div style={{display:"flex",gap:8}}>
          {bom.length>0&&(
            <button onClick={exportCSV} style={btn(C.greenDim,C.green,{fontSize:13})}>â¬‡ Export CSV</button>
          )}
          <button onClick={runExtraction} disabled={running||!bomPages.length||readOnly} style={btn(C.accent,"#fff",{fontSize:13,opacity:running||!bomPages.length||readOnly?0.5:1})}>
            {running?"Extractingâ€¦":"ðŸ” Run Extraction"}
          </button>
        </div>
      </div>

      {progress&&(
        <div style={{...card({padding:16}),marginBottom:16}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
            <span style={{fontSize:13,color:C.sub}}>{progress.msg}</span>
            <span style={{fontSize:13,fontWeight:700,color:C.accent}}>{progress.pct}%</span>
          </div>
          <div style={{background:C.border,borderRadius:4,height:6,overflow:"hidden"}}>
            <div style={{width:`${progress.pct}%`,height:"100%",background:C.accent,borderRadius:4,transition:"width 0.4s"}}/>
          </div>
        </div>
      )}

      {err&&(
        <div style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:10,padding:12,marginBottom:16,fontSize:13,color:C.red}}>{err}</div>
      )}

      {bom.length>0?(
        <div>
          <div style={{overflowX:"auto",borderRadius:10,border:`1px solid ${C.border}`}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
              <thead>
                <tr style={{background:"#0a0a12"}}>
                  {[["Qty",60],["Part Number",140],["Description",0],["Manufacturer",140],["Notes",160],["",40]].map(([h,w])=>(
                    <th key={h} style={{padding:"10px 12px",textAlign:"left",color:C.muted,fontWeight:600,fontSize:11,whiteSpace:"nowrap",width:w||"auto",borderBottom:`1px solid ${C.border}`}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {bom.map((row,i)=>(
                  <tr key={row.id} style={{borderBottom:i<bom.length-1?`1px solid ${C.border}22`:"none"}}>
                    {[["qty",60],["partNumber",140],["description",0],["manufacturer",140],["notes",160]].map(([f,w])=>(
                      <td key={f} style={{padding:"4px 6px",width:w||"auto"}}>
                        <input
                          value={row[f]||""}
                          onChange={e=>updateRow(row.id,f,e.target.value)}
                          style={{...inp({padding:"6px 8px",fontSize:13,borderColor:"transparent",background:"transparent",borderRadius:6}),width:w?w+"px":"100%",minWidth:w?w+"px":"160px"}}
                          onFocus={e=>e.target.style.borderColor=C.accent}
                          onBlur={e=>e.target.style.borderColor="transparent"}
                        />
                      </td>
                    ))}
                    <td style={{padding:"4px 6px",textAlign:"center"}}>
                      <button onClick={()=>deleteRow(row.id)} style={{background:"none",border:"none",color:C.red,cursor:"pointer",fontSize:14,opacity:0.4,padding:"4px 6px"}} onMouseEnter={e=>e.target.style.opacity=1} onMouseLeave={e=>e.target.style.opacity=0.4}>âœ•</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <button onClick={addRow} style={{...btn("transparent",C.accent,{marginTop:10,fontSize:13,border:`1px dashed ${C.accent}44`,width:"100%",padding:"10px"})}}>+ Add Row</button>
        </div>
      ):(
        !running&&(
          <div style={{textAlign:"center",padding:60,color:C.muted}}>
            <div style={{fontSize:44,marginBottom:12,opacity:0.3}}>ðŸ“‹</div>
            <div style={{fontSize:16,fontWeight:600,color:C.sub,marginBottom:8}}>No BOM data yet</div>
            <div style={{fontSize:13,lineHeight:1.7}}>
              {bomPages.length===0
                ?"Tag your BOM pages in the Drawings tab, then return here."
                :"Click Run Extraction to analyze your BOM pages."}
            </div>
          </div>
        )
      )}
    </div>
  );
}

// â”€â”€ VALIDATE TAB â”€â”€
function ValidateTab({project,uid,onUpdate,onSaveImmediate,readOnly}){
  const [running,setRunning]=useState(false);
  const [progress,setProgress]=useState(null);
  const [err,setErr]=useState("");

  const schematicPages=(project.pages||[]).filter(p=>p.type==="schematic");
  const v=project.validation;

  async function runValidation(){
    if(!schematicPages.length){setErr("No pages tagged as Schematic. Tag your schematic pages in the Drawings tab first.");return;}
    setRunning(true);setErr("");setProgress({msg:"Startingâ€¦",pct:5});
    let allTags=[];
    let totalWires=0;
    for(let i=0;i<schematicPages.length;i++){
      const pg=schematicPages[i];
      if(!pg.dataUrl){setErr(`Page "${pg.name}" has no image data. Please re-upload the PDF.`);setRunning(false);return;}
      setProgress({msg:`Analyzing page ${i+1} of ${schematicPages.length}: ${pg.name}â€¦`,pct:10+Math.round((i/schematicPages.length)*75)});
      try{
        const result=await analyzeSchematicPage(pg.dataUrl);
        allTags=[...allTags,...result.tags];
        totalWires+=result.wireCount;
      }catch(ex){setErr(`Failed on ${pg.name}: ${ex.message}`);setRunning(false);return;}
      setProgress({msg:`Page ${i+1} of ${schematicPages.length} done â€” ${allTags.length} tags so far`,pct:10+Math.round(((i+1)/schematicPages.length)*75)});
    }
    setProgress({msg:"Cross-referencing BOMâ€¦",pct:90});
    const schematicTags=[...new Set(allTags.map(t=>t.trim()).filter(Boolean))];
    const allTagsSet=new Set(schematicTags.map(t=>t.toUpperCase()));
    const isAsShown=notes=>/^(as\s+shown|enclosure)$/i.test(notes.trim());
    const matched=[],missing=[],notTraceable=[];
    for(const item of (project.bom||[])){
      const notes=(item.notes||"").trim();
      if(isAsShown(notes)){notTraceable.push(item);continue;}
      const itemTags=notes.split(/[\s,;]+/).filter(Boolean);
      const found=itemTags.filter(t=>allTagsSet.has(t.toUpperCase()));
      if(found.length>0||itemTags.length===0)matched.push({item,found});
      else missing.push(item);
    }
    const allBomTags=new Set((project.bom||[]).flatMap(i=>(i.notes||"").split(/[\s,;]+/).filter(Boolean).map(t=>t.toUpperCase())));
    const unaccounted=schematicTags.filter(t=>!allBomTags.has(t.toUpperCase()));
    // Confidence only counts traceable items (excludes AS SHOWN)
    const traceable=(project.bom||[]).length-notTraceable.length;
    const matchPct=traceable>0?matched.length/traceable:1;
    const confidence=matchPct>=0.9?"high":matchPct>=0.7?"medium":"low";
    const validation={runAt:Date.now(),schematicTags,wireCount:totalWires,matched,missingFromSchematic:missing,notTraceable,unaccountedTags:unaccounted,confidence};
    setProgress({msg:"Saving resultsâ€¦",pct:97});
    const updated={...project,validation,status:"validated",updatedAt:Date.now()};
    if(onSaveImmediate){try{await onSaveImmediate(updated);}catch(ex){setErr(`Save failed: ${ex.message}`);}}
    else{try{await saveProject(uid,updated);}catch(ex){setErr(`Save failed: ${ex.message}`);}}
    onUpdate(updated);
    setProgress({msg:`Complete â€” ${schematicTags.length} tags found, ${matched.length} BOM items matched.`,pct:100});
    setRunning(false);
  }

  const confColor={high:C.green,medium:C.yellow,low:C.red};

  // â”€â”€ Validation actions â”€â”€
  const liveBom=project.bom||[];
  const actionOf=id=>liveBom.find(r=>r.id===id)?.validationAction||null;
  const tagActionOf=tag=>project.validation?.tagActions?.[tag]||null;

  function actionMissing(item,action){
    const bom=liveBom.map(r=>r.id===item.id?{...r,validationAction:action}:r);
    let quote=project.quote||{};
    if(action==="noted"){
      const note=`âš  ${item.partNumber||item.description||"Item"} (${item.notes||"no ref"}) â€” in BOM but not found in schematic`;
      quote={...quote,notes:[quote.notes,note].filter(Boolean).join("\n")};
    }
    onUpdate({...project,bom,quote});
  }

  function actionTag(tag,action){
    const tagActions={...(project.validation?.tagActions||{}),[tag]:action};
    const validation={...project.validation,tagActions};
    let bom=liveBom;
    let quote=project.quote||{};
    if(action==="accepted"){
      bom=[...bom,{id:Date.now()+Math.random(),qty:1,partNumber:"",description:tag,manufacturer:"",notes:tag}];
    }
    if(action==="noted"){
      const note=`âš  Tag ${tag} â€” found in schematic but not in BOM, requires review`;
      quote={...quote,notes:[quote.notes,note].filter(Boolean).join("\n")};
    }
    onUpdate({...project,bom,validation,quote});
  }

  function ActionBtns({action,onAction}){
    if(action){
      const map={accepted:[C.greenDim,C.green,"âœ“ Accepted"],ignored:[C.border,C.muted,"â€” Ignored"],noted:[C.yellowDim,C.yellow,"ðŸ“ Noted"]};
      const [bg,col,label]=map[action]||map.ignored;
      return<span style={{background:bg,color:col,borderRadius:10,padding:"2px 10px",fontSize:11,fontWeight:700,whiteSpace:"nowrap"}}>{label}</span>;
    }
    return(
      <div style={{display:"flex",gap:4,flexWrap:"nowrap"}}>
        <button onClick={()=>onAction("accepted")} style={btn(C.greenDim,C.green,{fontSize:11,padding:"3px 8px",borderRadius:6})}>âœ“ Accept</button>
        <button onClick={()=>onAction("ignored")}  style={btn(C.border,C.muted,{fontSize:11,padding:"3px 8px",borderRadius:6})}>â€” Ignore</button>
        <button onClick={()=>onAction("noted")}    style={btn(C.yellowDim,C.yellow,{fontSize:11,padding:"3px 8px",borderRadius:6})}>ðŸ“ Note</button>
      </div>
    );
  }

  return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:20,flexWrap:"wrap",gap:12}}>
        <div>
          <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Schematic Validation</div>
          <div style={{fontSize:13,color:C.muted}}>{schematicPages.length} schematic page{schematicPages.length!==1?"s":""} tagged{v?` Â· last run ${new Date(v.runAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`:""}</div>
        </div>
        <button onClick={runValidation} disabled={running||!schematicPages.length||readOnly} style={btn(C.accent,"#fff",{fontSize:13,opacity:running||!schematicPages.length||readOnly?0.5:1})}>
          {running?"Analyzingâ€¦":"âœ… Run Validation"}
        </button>
      </div>

      {progress&&(
        <div style={{...card({padding:16}),marginBottom:16}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
            <span style={{fontSize:13,color:C.sub}}>{progress.msg}</span>
            <span style={{fontSize:13,fontWeight:700,color:C.accent}}>{progress.pct}%</span>
          </div>
          <div style={{background:C.border,borderRadius:4,height:6,overflow:"hidden"}}>
            <div style={{width:`${progress.pct}%`,height:"100%",background:C.accent,borderRadius:4,transition:"width 0.4s"}}/>
          </div>
        </div>
      )}

      {err&&(
        <div style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:10,padding:12,marginBottom:16,fontSize:13,color:C.red}}>{err}</div>
      )}

      {!v&&!running&&(
        <div style={{...card(),textAlign:"center",padding:"48px 20px",color:C.muted}}>
          <div style={{fontSize:44,marginBottom:12,opacity:0.3}}>âœ…</div>
          <div style={{fontSize:16,fontWeight:600,color:C.sub,marginBottom:8}}>No validation results yet</div>
          <div style={{fontSize:13,lineHeight:1.7}}>
            {schematicPages.length===0
              ?"Tag your schematic pages in the Drawings tab, then return here."
              :"Click Run Validation to cross-reference BOM against schematics."}
          </div>
        </div>
      )}

      {v&&(
        <div className="fade-in">
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))",gap:12,marginBottom:16}}>
            <div style={{...card({padding:"14px 16px"}),borderColor:C.green+"44"}}>
              <div style={{fontSize:24,fontWeight:800,color:C.green}}>{v.matched?.length||0}</div>
              <div style={{fontSize:12,color:C.sub,marginTop:2}}>âœ… Matched</div>
            </div>
            <div style={{...card({padding:"14px 16px"}),borderColor:C.yellow+"44"}}>
              <div style={{fontSize:24,fontWeight:800,color:C.yellow}}>{v.missingFromSchematic?.length||0}</div>
              <div style={{fontSize:12,color:C.sub,marginTop:2}}>âš ï¸ Missing from schematic</div>
            </div>
            <div style={{...card({padding:"14px 16px"})}}>
              <div style={{fontSize:24,fontWeight:800,color:C.muted}}>{v.unaccountedTags?.length||0}</div>
              <div style={{fontSize:12,color:C.sub,marginTop:2}}>â“ Unaccounted tags</div>
            </div>
            <div style={{...card({padding:"14px 16px"}),borderColor:C.accent+"44"}}>
              <div style={{fontSize:24,fontWeight:800,color:C.accent}}>{v.wireCount||0}</div>
              <div style={{fontSize:12,color:C.sub,marginTop:2}}>ðŸ”Œ Wires</div>
            </div>
            <div style={{...card({padding:"14px 16px"}),borderColor:C.purple+"44"}}>
              <div style={{fontSize:24,fontWeight:800,color:C.purple}}>{v.notTraceable?.length||0}</div>
              <div style={{fontSize:12,color:C.sub,marginTop:2}}>ðŸ“‹ Review required</div>
            </div>
          </div>

          <div style={{...card({padding:"12px 16px"}),marginBottom:16,display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"}}>
            <div style={{fontSize:13,color:C.sub}}>Confidence: <strong style={{color:confColor[v.confidence]||C.muted}}>{(v.confidence||"â€”").toUpperCase()}</strong></div>
            <div style={{width:1,height:16,background:C.border}}/>
            <div style={{fontSize:13,color:C.sub}}>~{v.wireCount||0} wires â†’ estimated <strong style={{color:C.text}}>{Math.ceil((v.wireCount||0)/12)}â€“{Math.ceil((v.wireCount||0)/8)} labor hours</strong></div>
            <div style={{width:1,height:16,background:C.border}}/>
            <div style={{fontSize:13,color:C.sub}}>{v.schematicTags?.length||0} unique tags Â· {schematicPages.length} page{schematicPages.length!==1?"s":""} analyzed</div>
          </div>

          {v.missingFromSchematic?.length>0&&(
            <div style={{...card({padding:0,overflow:"hidden"}),marginBottom:16}}>
              <div style={{padding:"12px 16px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
                <span style={{color:C.yellow,fontSize:15}}>âš ï¸</span>
                <span style={{fontSize:14,fontWeight:700}}>Missing from Schematic</span>
                <span style={{fontSize:12,color:C.muted,marginLeft:"auto"}}>{v.missingFromSchematic.length} BOM item{v.missingFromSchematic.length!==1?"s":""} with no matching tag found</span>
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                <thead>
                  <tr style={{background:"#0a0a12"}}>
                    {["Part Number","Description","Notes (Ref Tags)","Action"].map(h=>(
                      <th key={h} style={{padding:"8px 12px",textAlign:"left",color:C.muted,fontWeight:600,fontSize:11,borderBottom:`1px solid ${C.border}`}}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {v.missingFromSchematic.map((item,i)=>{
                    const action=actionOf(item.id);
                    return(
                      <tr key={item.id||i} style={{borderBottom:i<v.missingFromSchematic.length-1?`1px solid ${C.border}22`:"none",opacity:action==="ignored"?0.4:1}}>
                        <td style={{padding:"8px 12px",color:C.sub,whiteSpace:"nowrap"}}>{item.partNumber||"â€”"}</td>
                        <td style={{padding:"8px 12px",color:C.text}}>{item.description||"â€”"}</td>
                        <td style={{padding:"8px 12px",color:C.yellow}}>{item.notes||"â€”"}</td>
                        <td style={{padding:"6px 12px",whiteSpace:"nowrap"}}><ActionBtns action={action} onAction={a=>actionMissing(item,a)}/></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}

          {v.notTraceable?.length>0&&(
            <div style={{...card({padding:0,overflow:"hidden"}),marginBottom:16}}>
              <div style={{padding:"12px 16px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
                <span style={{color:C.purple,fontSize:15}}>ðŸ“‹</span>
                <span style={{fontSize:14,fontWeight:700}}>Review Required</span>
                <span style={{fontSize:12,color:C.muted,marginLeft:"auto"}}>{v.notTraceable.length} item{v.notTraceable.length!==1?"s":""} tagged "AS SHOWN" â€” no schematic ref designator to match</span>
              </div>
              <div style={{padding:"8px 16px",background:C.purple+"11",borderBottom:`1px solid ${C.border}`,fontSize:12,color:C.sub}}>
                These items have no unique device tag on the schematic. Verify manually that each is physically present in the panel.
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                <thead>
                  <tr style={{background:"#0a0a12"}}>
                    {["Part Number","Description","Qty"].map(h=>(
                      <th key={h} style={{padding:"8px 12px",textAlign:"left",color:C.muted,fontWeight:600,fontSize:11,borderBottom:`1px solid ${C.border}`}}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {v.notTraceable.map((item,i)=>(
                    <tr key={item.id||i} style={{borderBottom:i<v.notTraceable.length-1?`1px solid ${C.border}22`:"none"}}>
                      <td style={{padding:"8px 12px",color:C.sub,whiteSpace:"nowrap"}}>{item.partNumber||"â€”"}</td>
                      <td style={{padding:"8px 12px",color:C.text}}>{item.description||"â€”"}</td>
                      <td style={{padding:"8px 12px",color:C.muted}}>{item.qty||"â€”"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {v.unaccountedTags?.length>0&&(
            <div style={{...card({padding:0,overflow:"hidden"})}}>
              <div style={{padding:"12px 16px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
                <span style={{color:C.muted,fontSize:15}}>â“</span>
                <span style={{fontSize:14,fontWeight:700}}>Unaccounted Tags</span>
                <span style={{fontSize:12,color:C.muted,marginLeft:"auto"}}>{v.unaccountedTags.length} tag{v.unaccountedTags.length!==1?"s":""} in schematic not found in BOM</span>
              </div>
              <div style={{padding:"8px 16px",background:C.border+"22",borderBottom:`1px solid ${C.border}`,fontSize:12,color:C.sub}}>
                Accept â†’ adds a new BOM row for pricing Â· Ignore â†’ dismisses Â· Note â†’ flags in quote
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                <thead>
                  <tr style={{background:"#0a0a12"}}>
                    {["Tag","Action"].map(h=>(
                      <th key={h} style={{padding:"8px 12px",textAlign:"left",color:C.muted,fontWeight:600,fontSize:11,borderBottom:`1px solid ${C.border}`}}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {v.unaccountedTags.map((t,i)=>{
                    const action=tagActionOf(t);
                    return(
                      <tr key={i} style={{borderBottom:i<v.unaccountedTags.length-1?`1px solid ${C.border}22`:"none",opacity:action==="ignored"?0.4:1}}>
                        <td style={{padding:"8px 12px",color:action==="accepted"?C.green:action==="noted"?C.yellow:C.sub}}>{t}</td>
                        <td style={{padding:"6px 12px"}}><ActionBtns action={action} onAction={a=>actionTag(t,a)}/></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// â”€â”€ PRICE TAB â”€â”€
function PriceTab({project,uid,onUpdate,onSaveImmediate,readOnly}){
  const [running,setRunning]=useState(false);
  const [progress,setProgress]=useState(null);
  const [err,setErr]=useState("");
  const [showConfig,setShowConfig]=useState(false);
  const pr=project.pricing||{};
  function setPr(updates){onUpdate({...project,pricing:{...pr,...updates}});}
  const markup=pr.markup??30;
  const laborRate=pr.laborRate??45;
  const contingencyBOM=pr.contingencyBOM??_pricingConfig.contingencyBOM;
  const contingencyConsumables=pr.contingencyConsumables??_pricingConfig.contingencyConsumables;
  const budgetaryPct=pr.budgetaryContingencyPct??_pricingConfig.budgetaryContingencyPct??20;

  const bom=project.bom||[];
  const wireCount=project.validation?.wireCount||0;
  const defaultHours=wireCount?Math.round((Math.ceil(wireCount/12)+Math.ceil(wireCount/8))/2):0;
  const laborHours=(pr.laborHoursOverride??null)??defaultHours;

  const totalCost=bom.reduce((s,r)=>s+(r.unitPrice||0)*(r.qty||1),0);
  const laborCost=laborHours*laborRate;
  const grandTotal=totalCost+laborCost+contingencyBOM+contingencyConsumables;
  const sellPrice=grandTotal*(1+markup/100);
  const pricedCount=bom.filter(r=>r.unitPrice!=null).length;

  async function runPricing(){
    if(!bom.length){setErr("No BOM items to price. Run extraction first.");return;}
    setRunning(true);setErr("");
    const BATCH=20;
    let updatedBom=[...bom];
    const total=Math.ceil(bom.length/BATCH);
    for(let i=0;i<bom.length;i+=BATCH){
      const batchIdx=Math.floor(i/BATCH);
      setProgress({msg:`Pricing items ${i+1}â€“${Math.min(i+BATCH,bom.length)} of ${bom.length}â€¦`,pct:Math.round((batchIdx/total)*90)+5});
      const batch=bom.slice(i,i+BATCH);
      try{
        const map=await estimatePrices(batch);
        updatedBom=updatedBom.map(r=>{
          const key=String(r.id);
          if(key in map){return{...r,unitPrice:map[key],priceSource:map[key]!=null?"ai":r.priceSource||null};}
          return r;
        });
      }catch(ex){setErr(`Pricing failed: ${ex.message}`);setRunning(false);return;}
    }
    setProgress({msg:"Saving pricesâ€¦",pct:97});
    const updated={...project,bom:updatedBom,updatedAt:Date.now()};
    if(onSaveImmediate){try{await onSaveImmediate(updated);}catch(ex){setErr(`Save failed: ${ex.message}`);}}
    else{try{await saveProject(uid,updated);}catch(ex){setErr(`Save failed: ${ex.message}`);}}
    onUpdate(updated);
    setProgress({msg:`Done â€” ${updatedBom.filter(r=>r.unitPrice!=null).length} of ${bom.length} items priced.`,pct:100});
    setRunning(false);
  }

  function updatePrice(id,val){
    const parsed=val===""?null:parseFloat(val);
    const updatedBom=bom.map(r=>r.id===id?{...r,unitPrice:isNaN(parsed)?null:parsed,priceSource:isNaN(parsed)||parsed===null?null:"manual"}:r);
    onUpdate({...project,bom:updatedBom,updatedAt:Date.now()});
  }

  function SourceBadge({src}){
    if(src==="ai")return<span style={{background:C.teal+"22",color:C.teal,borderRadius:10,padding:"2px 8px",fontSize:11,fontWeight:700,whiteSpace:"nowrap"}}>AI Est.</span>;
    if(src==="manual")return<span style={{background:C.accentDim,color:C.accent,borderRadius:10,padding:"2px 8px",fontSize:11,fontWeight:700,whiteSpace:"nowrap"}}>Manual</span>;
    return<span style={{color:C.muted,fontSize:12}}>â€”</span>;
  }

  const fmt=n=>n==null?"â€”":"$"+n.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});

  return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:20,flexWrap:"wrap",gap:12}}>
        <div>
          <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Pricing</div>
          <div style={{fontSize:13,color:C.muted}}>{bom.length} BOM items Â· {pricedCount} priced</div>
        </div>
        <button onClick={runPricing} disabled={running||!bom.length||readOnly} style={btn(C.accent,"#fff",{fontSize:13,opacity:running||!bom.length||readOnly?0.5:1})}>
          {running?"Estimatingâ€¦":"âœ¨ Get AI Estimates"}
        </button>
      </div>

      {progress&&(
        <div style={{...card({padding:16}),marginBottom:16}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
            <span style={{fontSize:13,color:C.sub}}>{progress.msg}</span>
            <span style={{fontSize:13,fontWeight:700,color:C.accent}}>{progress.pct}%</span>
          </div>
          <div style={{background:C.border,borderRadius:4,height:6,overflow:"hidden"}}>
            <div style={{width:`${progress.pct}%`,height:"100%",background:C.accent,borderRadius:4,transition:"width 0.4s"}}/>
          </div>
        </div>
      )}

      {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:10,padding:12,marginBottom:16,fontSize:13,color:C.red}}>{err}</div>}

      {pricedCount>0&&(
        <div style={{...card({padding:"12px 16px"}),marginBottom:16,display:"flex",gap:20,flexWrap:"wrap",alignItems:"center"}}>
          <span style={{fontSize:13,color:C.sub}}><strong style={{color:C.text}}>{pricedCount}</strong> of {bom.length} items priced</span>
          <div style={{width:1,height:16,background:C.border}}/>
          <span style={{fontSize:13,color:C.sub}}>Total cost: <strong style={{color:C.green}}>{fmt(totalCost)}</strong></span>
          {bom.length-pricedCount>0&&<><div style={{width:1,height:16,background:C.border}}/><span style={{fontSize:13,color:C.yellow}}>{bom.length-pricedCount} unpriced</span></>}
        </div>
      )}

      {bom.length>0?(
        <div>
          <div style={{overflowX:"auto",borderRadius:10,border:`1px solid ${C.border}`,marginBottom:16}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
              <thead>
                <tr style={{background:"#0a0a12"}}>
                  {[["Qty",50],["Part #",130],["Description",0],["Unit Price",110],["Source",90],["Ext. Price",100]].map(([h,w])=>(
                    <th key={h} style={{padding:"10px 12px",textAlign:h==="Unit Price"||h==="Ext. Price"?"right":"left",color:C.muted,fontWeight:600,fontSize:11,whiteSpace:"nowrap",width:w||"auto",borderBottom:`1px solid ${C.border}`}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {bom.map((row,i)=>{
                  const ext=(row.unitPrice||0)*(row.qty||1);
                  return(
                    <tr key={row.id} style={{borderBottom:i<bom.length-1?`1px solid ${C.border}22`:"none"}}>
                      <td style={{padding:"6px 12px",color:C.muted,whiteSpace:"nowrap"}}>{row.qty||1}</td>
                      <td style={{padding:"6px 12px",color:C.sub,whiteSpace:"nowrap"}}>{row.partNumber||"â€”"}</td>
                      <td style={{padding:"6px 12px",color:C.text}}>{row.description||"â€”"}</td>
                      <td style={{padding:"4px 8px",textAlign:"right"}}>
                        <div style={{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:2}}>
                          <span style={{color:C.muted,fontSize:13}}>$</span>
                          <input
                            type="number"
                            min="0"
                            step="0.01"
                            value={row.unitPrice!=null?parseFloat(row.unitPrice).toFixed(2):""}
                            onChange={e=>updatePrice(row.id,e.target.value)}
                            placeholder="0.00"
                            style={{...inp({padding:"5px 6px",fontSize:13,borderColor:"transparent",background:"transparent",borderRadius:6,textAlign:"right",width:80}),minWidth:80}}
                            onFocus={e=>{e.target.style.borderColor=C.accent;e.target.value=row.unitPrice??""}}
                            onBlur={e=>{e.target.style.borderColor="transparent";if(e.target.value!=="")e.target.value=parseFloat(e.target.value).toFixed(2);}}
                          />
                        </div>
                      </td>
                      <td style={{padding:"6px 12px",textAlign:"center"}}><SourceBadge src={row.priceSource}/></td>
                      <td style={{padding:"6px 12px",textAlign:"right",color:row.unitPrice!=null?C.text:C.muted,fontVariantNumeric:"tabular-nums"}}>
                        {row.unitPrice!=null?fmt(ext):"â€”"}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {(totalCost>0||laborCost>0)&&(
            <div style={{...card({padding:20}),maxWidth:420}}>
              <div style={{fontSize:15,fontWeight:700,marginBottom:16}}>Cost Summary</div>

              {/* Materials */}
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:10,fontSize:14}}>
                <span style={{color:C.sub}}>Materials</span>
                <span style={{fontWeight:600,color:C.green,fontVariantNumeric:"tabular-nums"}}>{fmt(totalCost)}</span>
              </div>

              {/* Labor */}
              <div style={{background:"#0a0a12",border:`1px solid ${C.border}`,borderRadius:8,padding:"10px 12px",marginBottom:12}}>
                <div style={{fontSize:12,color:C.muted,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5,marginBottom:8}}>Labor</div>
                <div style={{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"}}>
                  <span style={{fontSize:13,color:C.sub,whiteSpace:"nowrap",minWidth:36}}>Hrs</span>
                  <input
                    type="number"
                    min="0"
                    step="0.5"
                    value={laborHours}
                    onChange={e=>setPr({laborHoursOverride:Math.max(0,+e.target.value||0)})}
                    style={{...inp({padding:"5px 8px",fontSize:13,width:80,textAlign:"right"})}}
                  />
                  <span style={{fontSize:13,color:C.muted}}>Ã—</span>
                  <span style={{fontSize:13,color:C.sub,whiteSpace:"nowrap"}}>$</span>
                  <input
                    type="number"
                    min="0"
                    step="1"
                    value={laborRate}
                    onChange={e=>setPr({laborRate:Math.max(0,+e.target.value||0)})}
                    style={{...inp({padding:"5px 8px",fontSize:13,width:80,textAlign:"right"})}}
                  />
                  <span style={{fontSize:13,color:C.muted}}>/hr</span>
                </div>
                {wireCount>0&&(pr.laborHoursOverride??null)===null&&(
                  <div style={{fontSize:11,color:C.muted}}>
                    Estimated from {wireCount} wires ({Math.ceil(wireCount/12)}â€“{Math.ceil(wireCount/8)} hrs range) Â· edit to override
                  </div>
                )}
                <div style={{display:"flex",justifyContent:"flex-end",marginTop:4,fontSize:13,color:C.sub}}>
                  Labor cost: <strong style={{color:C.text,marginLeft:6,fontVariantNumeric:"tabular-nums"}}>{fmt(laborCost)}</strong>
                </div>
              </div>

              {/* Contingencies */}
              {[
                ["BOM Contingency","$",contingencyBOM,"contingencyBOM"],
                ["Wire / Zip Ties / etc.","$",contingencyConsumables,"contingencyConsumables"]
              ].map(([label,prefix,val,key])=>(
                <div key={label} style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10,gap:8}}>
                  <div style={{display:"flex",alignItems:"center",gap:4,flex:1}}>
                    <span style={{fontSize:13,color:C.sub}}>{label}</span>
                    <button onClick={()=>setShowConfig(true)} title="Edit defaults" style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:11,padding:"1px 4px",opacity:0.6,lineHeight:1}} onMouseEnter={e=>e.target.style.opacity=1} onMouseLeave={e=>e.target.style.opacity=0.6}>âš™</button>
                  </div>
                  <div style={{display:"flex",alignItems:"center",gap:4}}>
                    <span style={{fontSize:13,color:C.muted}}>{prefix}</span>
                    <input
                      type="number"
                      min="0"
                      step="50"
                      value={val}
                      onChange={e=>setPr({[key]:Math.max(0,+e.target.value||0)})}
                      style={{...inp({padding:"5px 8px",fontSize:13,width:90,textAlign:"right"})}}
                    />
                  </div>
                </div>
              ))}

              {/* Grand total + markup */}
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:10,fontSize:14}}>
                <span style={{color:C.sub}}>Total (mat. + labor)</span>
                <span style={{fontWeight:700,color:C.text,fontVariantNumeric:"tabular-nums"}}>{fmt(grandTotal)}</span>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:12}}>
                <span style={{fontSize:14,color:C.sub,whiteSpace:"nowrap"}}>Markup %</span>
                <input
                  type="number"
                  min="0"
                  step="1"
                  value={markup}
                  onChange={e=>setPr({markup:Math.max(0,+e.target.value||0)})}
                  style={{...inp({padding:"6px 10px",fontSize:14,width:90,textAlign:"right"})}}
                />
              </div>
              <div style={{borderTop:`1px solid ${C.border}`,paddingTop:12,display:"flex",justifyContent:"space-between",fontSize:15,marginBottom:12}}>
                <span style={{fontWeight:700}}>Sell Price</span>
                <span style={{fontWeight:800,color:C.accent,fontVariantNumeric:"tabular-nums"}}>{fmt(sellPrice)}</span>
              </div>

              {/* Budgetary contingency */}
              <div style={{borderTop:`1px solid ${C.border}`,paddingTop:12}}>
                <div style={{fontSize:11,color:C.muted,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5,marginBottom:8}}>Budgetary Estimate</div>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}>
                  <span style={{fontSize:13,color:C.sub,flex:1}}>Budgetary Contingency %</span>
                  <input
                    type="number"
                    min="0"
                    step="1"
                    value={budgetaryPct}
                    onChange={e=>setPr({budgetaryContingencyPct:Math.max(0,+e.target.value||0)})}
                    style={{...inp({padding:"5px 8px",fontSize:13,width:80,textAlign:"right"})}}
                    disabled={readOnly}
                  />
                  <span style={{fontSize:13,color:C.muted}}>%</span>
                </div>
                <div style={{display:"flex",justifyContent:"space-between",fontSize:14}}>
                  <span style={{color:C.sub}}>Budgetary Sell Price</span>
                  <span style={{fontWeight:700,color:C.yellow,fontVariantNumeric:"tabular-nums"}}>{fmt(sellPrice*(1+budgetaryPct/100))}</span>
                </div>
              </div>
            </div>
          )}
        </div>
      ):(
        !running&&(
          <div style={{textAlign:"center",padding:60,color:C.muted}}>
            <div style={{fontSize:44,marginBottom:12,opacity:0.3}}>ðŸ’²</div>
            <div style={{fontSize:16,fontWeight:600,color:C.sub,marginBottom:8}}>No BOM items to price</div>
            <div style={{fontSize:13,lineHeight:1.7}}>Run extraction first to populate the BOM, then return here.</div>
          </div>
        )
      )}
      {showConfig&&<PricingConfigModal uid={uid} onClose={()=>setShowConfig(false)}/>}
    </div>
  );
}

// â”€â”€ BUDGETARY QUOTE TAB â”€â”€
function BudgetaryQuoteTab({project,onUpdate}){
  const bq=project.budgetaryQuote;
  const q=project.quote||{};
  const pages=project.pages||[];
  const [desc,setDesc]=useState(()=>
    `Based on preliminary review of ${pages.length} drawing page${pages.length!==1?"s":""}, this budgetary estimate covers a UL508A industrial control panel as described in the uploaded drawings.`
  );

  const W={bg:"#fff",text:"#111",sub:"#333",muted:"#666",faint:"#999",border:"#ccc",light:"#f4f4f4",accent:"#1a56db",amber:"#92400e",amberBg:"#fef3c7",amberBorder:"#d97706"};
  const fmtMoney=n=>"$"+n.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
  const today=new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});

  if(!bq){
    return(
      <div style={{textAlign:"center",padding:"60px 20px",color:C.muted}}>
        <div style={{fontSize:44,marginBottom:12,opacity:0.3}}>âš¡</div>
        <div style={{fontSize:16,fontWeight:600,color:C.sub,marginBottom:8}}>No Budgetary Quote Yet</div>
        <div style={{fontSize:13,lineHeight:1.7}}>
          Go to the <strong style={{color:C.text}}>Drawings</strong> tab and click <strong style={{color:C.yellow}}>âš¡ Fast Quote</strong> to auto-generate a budgetary estimate from your uploaded drawings.
        </div>
      </div>
    );
  }

  return(
    <div>
      <div className="no-print" style={{display:"flex",justifyContent:"flex-end",marginBottom:16}}>
        <button onClick={()=>window.print()} style={btn(C.accent,"#fff",{fontSize:13})}>ðŸ–¨ Print / Save PDF</button>
      </div>

      <div style={{background:W.bg,color:W.text,maxWidth:860,margin:"0 auto",padding:"28px 32px",borderRadius:8,border:`1px solid ${C.border}`,fontFamily:"Arial,sans-serif",fontSize:13,lineHeight:1.5}}>

        {/* Amber warning banner */}
        <div style={{background:W.amberBg,border:`2px solid ${W.amberBorder}`,borderRadius:6,padding:"10px 16px",marginBottom:20,textAlign:"center"}}>
          <div style={{fontWeight:800,color:W.amber,fontSize:13,letterSpacing:0.5}}>BUDGETARY ESTIMATE â€” NOT FOR PURCHASE ORDER USE</div>
        </div>

        {/* Letterhead */}
        <div style={{borderBottom:`2px solid ${W.border}`,paddingBottom:14,marginBottom:18,display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <div style={{display:"flex",alignItems:"center",gap:14}}>
            <div style={{fontSize:34,lineHeight:1}}>âš™</div>
            <div>
              <div style={{fontSize:18,fontWeight:800,color:W.accent,letterSpacing:-0.3}}>Matrix Systems</div>
              <div style={{fontSize:12,color:W.sub}}>5591 Leo Park Road Â· West Jordan, UT 84081</div>
            </div>
          </div>
          <div style={{textAlign:"right"}}>
            <div style={{fontSize:14,fontWeight:700,color:W.text,marginBottom:2}}>Budgetary Estimate</div>
            <div style={{fontSize:12,color:W.muted}}>{today}</div>
          </div>
        </div>

        {/* Customer info */}
        {(q.contact||q.company||q.address)&&(
          <div style={{marginBottom:16}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
              <tbody>
                <tr>
                  <td style={{width:90,verticalAlign:"top",fontStyle:"italic",fontWeight:600,paddingTop:2,color:W.sub}}>Attention:</td>
                  <td>
                    {q.contact&&<div style={{fontWeight:600}}>{q.contact}</div>}
                    {q.company&&<div style={{fontWeight:700,fontSize:14}}>{q.company}</div>}
                    {q.address&&<div style={{color:W.sub}}>{q.address}</div>}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        )}

        {/* RE: project */}
        <div style={{marginBottom:18,fontSize:13}}>
          <span style={{fontWeight:700,color:W.sub}}>RE:&nbsp;</span>
          <span style={{fontWeight:700}}>{project.name}</span>
        </div>

        {/* Description */}
        <div style={{marginBottom:18}}>
          <textarea
            value={desc}
            onChange={e=>setDesc(e.target.value)}
            rows={3}
            style={{width:"100%",background:"transparent",border:`1px dashed ${W.border}`,borderRadius:4,padding:"8px 10px",fontFamily:"Arial,sans-serif",fontSize:13,color:W.text,lineHeight:1.6,resize:"vertical",outline:"none"}}
          />
        </div>

        {/* Budgetary price â€” hero */}
        <div style={{background:W.light,border:`1px solid ${W.border}`,borderRadius:8,padding:"20px 24px",marginBottom:20,textAlign:"center"}}>
          <div style={{fontSize:11,color:W.muted,textTransform:"uppercase",letterSpacing:0.8,marginBottom:6}}>Budgetary Estimate Total</div>
          <div style={{fontSize:44,fontWeight:800,color:W.accent,fontVariantNumeric:"tabular-nums",letterSpacing:-1}}>{fmtMoney(bq.budgetarySellPrice)}</div>
          <div style={{fontSize:11,color:W.muted,marginTop:6}}>Includes materials, labor, and applicable contingencies.</div>
        </div>

        {/* Legal disclaimer */}
        <div style={{background:W.light,border:`1px solid ${W.border}`,borderRadius:6,padding:"12px 16px",fontSize:11,color:W.muted,lineHeight:1.8,fontStyle:"italic"}}>
          This budgetary estimate is provided for planning and preliminary budget purposes only, based on a high-level review of the provided drawings and specifications. It is NOT a formal quotation, does NOT constitute an offer to sell, and CANNOT be accepted as the basis for a Purchase Order or contract. Actual pricing is subject to change upon detailed engineering review, final specifications, material and labor costs at time of order, and other factors. Matrix Systems, Inc. makes no representation or warranty, express or implied, as to the accuracy or completeness of this estimate. To request a formal quotation, please contact Matrix Systems, Inc.
        </div>

        {/* Generated-at note */}
        <div style={{marginTop:14,fontSize:10,color:W.faint,textAlign:"right"}}>
          Generated {new Date(bq.generatedAt).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"})} Â· {bq.contingencyPct}% budgetary contingency applied
        </div>
      </div>
    </div>
  );
}

// â”€â”€ QUOTE TAB â”€â”€
function QuoteTab({project,onUpdate}){
  const [quoteTab,setQuoteTab]=useState("formal");
  const pr=project.pricing||{};
  const bom=project.bom||[];
  const wireCount=project.validation?.wireCount||0;
  const defaultHours=wireCount?Math.round((Math.ceil(wireCount/12)+Math.ceil(wireCount/8))/2):0;
  const laborHours=(pr.laborHoursOverride??null)??defaultHours;
  const laborRate=pr.laborRate??45;
  const markup=pr.markup??30;
  const contingencyBOM=pr.contingencyBOM??_pricingConfig.contingencyBOM;
  const contingencyConsumables=pr.contingencyConsumables??_pricingConfig.contingencyConsumables;
  const materialCost=bom.reduce((s,r)=>s+(r.unitPrice||0)*(r.qty||1),0);
  const laborCost=laborHours*laborRate;
  const grandTotal=materialCost+laborCost+contingencyBOM+contingencyConsumables;
  const sellPrice=grandTotal*(1+markup/100);
  const hasSellPrice=sellPrice>0;

  const q=project.quote||{};
  function setQ(updates){onUpdate({...project,quote:{...q,...updates}});}

  const today=new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});
  const defaultValidUntil=new Date(Date.now()+30*24*60*60*1000).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});
  const fmtMoney=n=>"$"+n.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});

  // Light-theme palette for the printable document
  const W={bg:"#fff",text:"#111",sub:"#333",muted:"#666",faint:"#999",border:"#ccc",light:"#f4f4f4",accent:"#1a56db"};
  const qInp=(x={})=>({background:"transparent",border:"none",borderBottom:`1px dashed ${W.border}`,outline:"none",color:W.text,fontSize:"inherit",fontFamily:"inherit",padding:"1px 2px",width:"100%",...x});

  return(
    <div>
      {/* Sub-tab bar */}
      <div className="no-print" style={{display:"flex",gap:4,marginBottom:20,borderBottom:`1px solid ${C.border}`}}>
        {[["formal","ðŸ“„ Formal Quote"],["budgetary","âš¡ Budgetary Quote"]].map(([id,label])=>(
          <button key={id} onClick={()=>setQuoteTab(id)}
            style={{background:"none",border:"none",borderBottom:`2px solid ${quoteTab===id?C.accent:"transparent"}`,color:quoteTab===id?C.accent:C.muted,padding:"10px 16px",fontSize:13,fontWeight:600,cursor:"pointer",marginBottom:-1,transition:"color 0.15s"}}>
            {label}
          </button>
        ))}
      </div>

      {/* Budgetary Quote sub-tab */}
      {quoteTab==="budgetary"&&<BudgetaryQuoteTab project={project} onUpdate={onUpdate}/>}

      {/* Formal Quote sub-tab */}
      {quoteTab==="formal"&&<div>
      {/* Toolbar */}
      <div className="no-print" style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12}}>
        <div>
          <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Formal Quote</div>
          <div style={{fontSize:13,color:C.muted}}>
            {hasSellPrice?`Sell price: ${fmtMoney(sellPrice)}`:"Complete pricing first to populate sell price."}
          </div>
        </div>
        <button onClick={()=>window.print()} style={btn(C.accent,"#fff",{fontSize:13})}>ðŸ–¨ Print / Save PDF</button>
      </div>

      {/* Quote document */}
      <div id="quote-doc" style={{background:W.bg,color:W.text,maxWidth:860,margin:"0 auto",padding:"28px 32px",borderRadius:8,border:`1px solid ${C.border}`,fontFamily:"Arial,sans-serif",fontSize:13,lineHeight:1.5}}>

        {/* Header box */}
        <div style={{border:`2px solid ${W.border}`,borderRadius:6,padding:"14px 18px",display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:18}}>
          <div style={{display:"flex",alignItems:"center",gap:14}}>
            <div style={{fontSize:36,lineHeight:1}}>âš™</div>
            <div>
              <div style={{fontSize:18,fontWeight:800,color:W.accent,letterSpacing:-0.3}}>Matrix Systems</div>
              <div style={{fontSize:12,color:W.sub}}>5591 Leo Park Road</div>
              <div style={{fontSize:12,color:W.sub}}>West Jordan, UT  84081  US</div>
            </div>
          </div>
          <div style={{textAlign:"right"}}>
            <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>
              Quote:&nbsp;&nbsp;
              <input value={q.number||""} onChange={e=>setQ({number:e.target.value})} placeholder="######" style={{...qInp({width:100,fontSize:18,fontWeight:700,textAlign:"right"})}}/>
            </div>
            <div style={{fontSize:13,color:W.sub,marginBottom:2}}>{q.date||today}</div>
            <div style={{fontSize:12,color:W.faint}}>Page 1 of 1</div>
          </div>
        </div>

        {/* Attention / Customer */}
        <table style={{width:"100%",marginBottom:14,fontSize:13,borderCollapse:"collapse"}}>
          <tbody>
            <tr>
              <td style={{width:90,verticalAlign:"top",fontStyle:"italic",fontWeight:600,paddingTop:2,color:W.sub}}>Attention:</td>
              <td style={{verticalAlign:"top"}}>
                <input value={q.contact||""} onChange={e=>setQ({contact:e.target.value})} placeholder="Contact name" style={{...qInp({fontWeight:600,marginBottom:4})}}/>
                <input value={q.company||""} onChange={e=>setQ({company:e.target.value})} placeholder="Company" style={{...qInp({fontWeight:700,fontSize:14,marginBottom:3})}}/>
                <input value={q.address||""} onChange={e=>setQ({address:e.target.value})} placeholder="Address" style={{...qInp({marginBottom:3})}}/>
                <div style={{display:"flex",gap:6}}>
                  <span style={{color:W.sub}}>Phone:</span>
                  <input value={q.phone||""} onChange={e=>setQ({phone:e.target.value})} placeholder="â€”" style={{...qInp({flex:1})}}/>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        {/* Project details */}
        <table style={{marginBottom:14,fontSize:13,borderCollapse:"collapse"}}>
          <tbody>
            {[
              ["Project #:",q.projectNumber,v=>setQ({projectNumber:v}),project.name],
              ["Pmt. Terms:",q.paymentTerms,v=>setQ({paymentTerms:v}),"Net 30 Days"],
              ["Shipping Method:",q.shippingMethod,v=>setQ({shippingMethod:v}),"Customer Handles Shipping"],
            ].map(([label,val,setter,ph])=>(
              <tr key={label}>
                <td style={{width:130,fontWeight:700,paddingRight:10,paddingBottom:3,color:W.sub,whiteSpace:"nowrap"}}>{label}</td>
                <td style={{paddingBottom:3}}><input value={val||""} onChange={e=>setter(e.target.value)} placeholder={ph} style={qInp({width:260})}/></td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* Terms */}
        <div style={{borderTop:`1px solid ${W.border}`,borderBottom:`1px solid ${W.border}`,padding:"8px 0",marginBottom:14,fontSize:11,color:W.muted,lineHeight:1.6}}>
          Standard Payment Terms for Panel Builds (Order Total over $30,000): 30% ARO; 40% @ Procurement, 30% @ Readiness To Ship<br/>
          Standard Payment Terms for Engineering / Programming: 50% ARO / 50% due @ Completion of Work<br/>
          <strong style={{color:W.text}}>All quotes expire 30 days from date of issue unless otherwise noted. Prices subject to change without notice.</strong>
        </div>

        {/* Line item */}
        <div style={{marginBottom:14}}>
          <div style={{display:"flex",gap:12,marginBottom:8}}>
            <span style={{fontStyle:"italic",fontWeight:700,color:W.sub,whiteSpace:"nowrap"}}>Line:&nbsp;1</span>
            <div style={{flex:1}}>
              <div style={{marginBottom:3}}>
                <span style={{fontWeight:700}}>Part #: </span>
                <input value={q.panelId||""} onChange={e=>setQ({panelId:e.target.value})} placeholder={project.name} style={{...qInp({display:"inline",width:200,fontWeight:700})}}/>
              </div>
              {[
                ["Description",q.description,v=>setQ({description:v}),project.name],
                ["Project",q.projectNumber,v=>setQ({projectNumber:v}),project.name],
                ["Drawing Rev",q.drawingRev,v=>setQ({drawingRev:v}),"A"],
                ["Panel ID",q.panelId,v=>setQ({panelId:v}),project.name],
                ["Plant Name",q.plantName,v=>setQ({plantName:v}),""],
                ["Supply Voltage",q.supplyVoltage,v=>setQ({supplyVoltage:v}),"480VAC"],
                ["Control Voltage",q.controlVoltage,v=>setQ({controlVoltage:v}),"120VAC"],
              ].map(([label,val,setter,ph])=>(
                <div key={label} style={{marginBottom:2}}>
                  <span style={{color:W.sub}}>{label}: </span>
                  <input value={val||""} onChange={e=>setter(e.target.value)} placeholder={ph} style={{...qInp({display:"inline",width:220})}}/>
                </div>
              ))}
              <div style={{marginTop:6}}>
                <div style={{color:W.sub,marginBottom:2}}>NOTES:</div>
                <textarea value={q.lineNotes||""} onChange={e=>setQ({lineNotes:e.target.value})} placeholder="e.g. Grey duct quoted instead of white." rows={2} style={{...qInp({display:"block",width:"100%",resize:"vertical",borderBottom:"none",border:`1px dashed ${W.border}`,borderRadius:3,padding:"4px 6px"})}}/>
              </div>
            </div>
          </div>

          {/* Missing Data â€” auto-populated from validation */}
          {(()=>{
            const v=project.validation;
            if(!v)return null;
            const lb=project.bom||[];
            const missing=(v.missingFromSchematic||[]).filter(i=>lb.find(r=>r.id===i.id)?.validationAction!=="ignored");
            const noId=(v.notTraceable||[]).filter(i=>lb.find(r=>r.id===i.id)?.validationAction!=="ignored");
            if(!missing.length&&!noId.length)return null;
            const th={padding:"1px 6px",textAlign:"left",color:W.muted,fontWeight:600,fontSize:8,textTransform:"uppercase",letterSpacing:0.3};
            const td={padding:"0px 6px",fontSize:8,lineHeight:1.4};
            return(
              <div style={{marginTop:6,borderTop:`1px solid ${W.border}`,paddingTop:4}}>
                <div style={{fontSize:8,fontWeight:700,textTransform:"uppercase",letterSpacing:0.6,color:W.text,marginBottom:2}}>Missing Data</div>
                {missing.length>0&&(
                  <div style={{marginBottom:2}}>
                    <div style={{fontSize:7,fontWeight:600,color:W.muted,textTransform:"uppercase",letterSpacing:0.3,marginBottom:1}}>In BOM â€” not found in schematic</div>
                    <table style={{width:"100%",borderCollapse:"collapse"}}>
                      <thead><tr>{["Part Number","Description","Ref Tags"].map(h=><th key={h} style={th}>{h}</th>)}</tr></thead>
                      <tbody>
                        {missing.map((item,i)=>(
                          <tr key={item.id||i}>
                            <td style={{...td,color:W.sub}}>{item.partNumber||"â€”"}</td>
                            <td style={{...td,color:W.text}}>{item.description||"â€”"}</td>
                            <td style={{...td,color:W.muted}}>{item.notes||"â€”"}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
                {noId.length>0&&(
                  <div>
                    <div style={{fontSize:7,fontWeight:600,color:W.muted,textTransform:"uppercase",letterSpacing:0.3,marginBottom:1}}>No device ID (AS SHOWN â€” field verification required)</div>
                    <table style={{width:"100%",borderCollapse:"collapse"}}>
                      <thead><tr>{["Part Number","Description","Qty"].map(h=><th key={h} style={th}>{h}</th>)}</tr></thead>
                      <tbody>
                        {noId.map((item,i)=>(
                          <tr key={item.id||i}>
                            <td style={{...td,color:W.sub}}>{item.partNumber||"â€”"}</td>
                            <td style={{...td,color:W.text}}>{item.description||"â€”"}</td>
                            <td style={{...td,color:W.muted}}>{item.qty||1}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            );
          })()}

          {/* Pricing table */}
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:13,marginTop:10}}>
            <thead>
              <tr style={{borderBottom:`1px solid ${W.border}`}}>
                {[["Quantity","left"],["U/M","left"],["Unit Price","left"],["Lead Time (Days)","left"],["Total Price","right"]].map(([h,a])=>(
                  <th key={h} style={{padding:"6px 10px",textAlign:a,fontStyle:"italic",fontWeight:600,color:W.sub,fontSize:12}}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              <tr style={{borderBottom:`1px solid ${W.border}`}}>
                <td style={{padding:"8px 10px"}}>
                  <input value={q.qty||"1.00"} onChange={e=>setQ({qty:e.target.value})} style={{...qInp({width:60})}}/>
                </td>
                <td style={{padding:"8px 10px"}}>EA</td>
                <td style={{padding:"8px 10px"}}>{hasSellPrice?fmtMoney(sellPrice):<span style={{color:W.faint}}>â€”</span>}</td>
                <td style={{padding:"8px 10px"}}>
                  <input value={q.leadTime||""} onChange={e=>setQ({leadTime:e.target.value})} placeholder="45-60" style={{...qInp({width:80})}}/>
                </td>
                <td style={{padding:"8px 10px",textAlign:"right",fontWeight:700}}>{hasSellPrice?fmtMoney(sellPrice*(parseFloat(q.qty)||1)):<span style={{color:W.faint}}>â€”</span>} {hasSellPrice&&<span style={{fontWeight:400,color:W.muted}}>*</span>}</td>
              </tr>
              <tr>
                <td colSpan={3} style={{padding:"6px 10px",fontSize:11,color:W.faint,fontStyle:"italic"}}>* Indicates which quantity price is included in the Total</td>
                <td style={{padding:"6px 10px",textAlign:"right",fontWeight:600,color:W.sub}}>Total:</td>
                <td style={{padding:"6px 10px",textAlign:"right",fontWeight:700}}>{hasSellPrice?fmtMoney(sellPrice*(parseFloat(q.qty)||1)):"â€”"}</td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* Notes */}
        <div style={{marginTop:18,borderTop:`1px solid ${W.border}`,paddingTop:14}}>
          <div style={{fontSize:12,fontWeight:700,textTransform:"uppercase",letterSpacing:0.6,color:W.text,marginBottom:8}}>Notes</div>
          <textarea
            value={q.notes||""}
            onChange={e=>setQ({notes:e.target.value})}
            placeholder="Quote terms, lead time, exclusions, etc."
            rows={3}
            style={{...qInp({display:"block",width:"100%",resize:"vertical",border:`1px dashed ${W.border}`,borderRadius:3,padding:"6px 8px",lineHeight:1.6,fontSize:13})}}
          />
        </div>

        {/* Footer */}
        <div style={{borderTop:`1px solid ${W.border}`,paddingTop:12,marginTop:16,display:"flex",justifyContent:"space-between",alignItems:"flex-end",flexWrap:"wrap",gap:12}}>
          <div style={{fontSize:13,color:W.sub}}>
            Salesperson:&nbsp;
            <input value={q.salesperson||""} onChange={e=>setQ({salesperson:e.target.value})} placeholder="â€”" style={{...qInp({display:"inline",width:160})}}/>
          </div>
          <div style={{fontSize:13,color:W.sub}}>
            Prices are Valid Until&nbsp;
            <input value={q.validUntil||""} onChange={e=>setQ({validUntil:e.target.value})} placeholder={defaultValidUntil} style={{...qInp({display:"inline",width:140})}}/>
          </div>
        </div>
      </div>
      </div>}
    </div>
  );
}

// â”€â”€ PLACEHOLDER TAB â”€â”€
function PlaceholderTab({icon,title,desc,coming}){
  return(
    <div style={{textAlign:"center",padding:"60px 20px",color:C.muted,maxWidth:520,margin:"0 auto"}}>
      <div style={{fontSize:52,marginBottom:16,opacity:0.3}}>{icon}</div>
      <div style={{fontSize:20,fontWeight:700,color:C.sub,marginBottom:10}}>{title}</div>
      <div style={{fontSize:14,lineHeight:1.8,marginBottom:28}}>{desc}</div>
      <div style={{textAlign:"left",display:"inline-block"}}>
        {coming.map((c,i)=>(
          <div key={i} style={{display:"flex",alignItems:"flex-start",gap:10,marginBottom:10,fontSize:13}}>
            <span style={{color:C.accent,marginTop:1}}>â—¦</span>
            <span style={{color:C.sub}}>{c}</span>
          </div>
        ))}
      </div>
      <div style={{marginTop:28,display:"inline-block",background:C.accentDim,color:C.accent,borderRadius:20,padding:"4px 16px",fontSize:12,fontWeight:700,letterSpacing:0.5}}>COMING SOON</div>
    </div>
  );
}

// â”€â”€ PANEL LIST VIEW â”€â”€
function PanelListView({project,uid,readOnly,onBack,onOpenPanel,onViewQuote,onUpdate}){
  function addPanel(){
    const n=(project.panels||[]).length+1;
    const newPanel={id:'panel-'+Date.now(),name:`Panel ${n}`,pages:[],bom:[],validation:null,pricing:null,budgetaryQuote:null,status:'draft'};
    onUpdate({...project,panels:[...(project.panels||[]),newPanel]});
  }
  function deletePanel(id){
    if(!window.confirm("Delete this panel and all its data?"))return;
    onUpdate({...project,panels:(project.panels||[]).filter(p=>p.id!==id)});
  }
  const panels=project.panels||[];
  return(
    <div style={{minHeight:"100vh",display:"flex",flexDirection:"column",background:C.bg}}>
      <div style={{background:C.card,borderBottom:`1px solid ${C.border}`,padding:"0 24px",display:"flex",alignItems:"center",gap:16,minHeight:52,flexShrink:0}}>
        <button onClick={onBack} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,display:"flex",alignItems:"center",gap:6,padding:"0",whiteSpace:"nowrap"}}>â† Projects</button>
        <div style={{width:1,height:18,background:C.border}}/>
        <div style={{fontSize:15,fontWeight:700,color:C.text,flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{project.name}</div>
        {readOnly&&<span style={{background:C.border,color:C.muted,borderRadius:20,padding:"2px 10px",fontSize:11,fontWeight:700}}>VIEW ONLY</span>}
      </div>
      <div style={{flex:1,overflowY:"auto",padding:24}}>
        <div style={{maxWidth:1100,margin:"0 auto"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:24,flexWrap:"wrap",gap:12}}>
            <div>
              <div style={{fontSize:22,fontWeight:800,marginBottom:4}}>Panels</div>
              <div style={{fontSize:13,color:C.muted}}>{panels.length} panel{panels.length!==1?"s":""} Â· click to open</div>
            </div>
            <div style={{display:"flex",gap:10}}>
              {panels.length>0&&<button onClick={onViewQuote} style={btn(C.greenDim,C.green,{fontSize:13})}>ðŸ“Š View Quote</button>}
              {!readOnly&&<button onClick={addPanel} style={btn(C.accent,"#fff",{fontSize:13})}>+ Add Panel</button>}
            </div>
          </div>
          {panels.length===0?(
            <div style={{textAlign:"center",padding:"60px 20px",color:C.muted}}>
              <div style={{fontSize:52,marginBottom:16,opacity:0.3}}>ðŸ—‚ï¸</div>
              <div style={{fontSize:18,fontWeight:700,color:C.sub,marginBottom:8}}>No panels yet</div>
              <div style={{fontSize:13,marginBottom:24,lineHeight:1.7}}>Add a panel to start uploading drawings and quoting this job.</div>
              {!readOnly&&<button onClick={addPanel} style={btn(C.accent,"#fff")}>+ Add First Panel</button>}
            </div>
          ):(
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:16}}>
              {panels.map(panel=>(
                <div key={panel.id} onClick={()=>onOpenPanel(panel)} className="fade-in"
                  style={{...card(),cursor:"pointer",transition:"border-color 0.15s,transform 0.15s"}}
                  onMouseEnter={e=>{e.currentTarget.style.borderColor=C.accent+"66";e.currentTarget.style.transform="translateY(-2px)";}}
                  onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.transform="none";}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
                    <div style={{fontSize:15,fontWeight:700,flex:1,marginRight:10,color:C.text,lineHeight:1.3}}>{panel.name}</div>
                    <Badge status={panel.status||"draft"}/>
                  </div>
                  <div style={{display:"flex",gap:16,fontSize:12,color:C.muted,marginBottom:14,flexWrap:"wrap"}}>
                    <span>ðŸ“‹ {(panel.bom||[]).length} items</span>
                    <span>ðŸ–¼ï¸ {(panel.pages||[]).length} pages</span>
                    {panel.validation?.wireCount>0&&<span>âš¡ {panel.validation.wireCount} wires</span>}
                  </div>
                  <div style={{display:"flex",justifyContent:"flex-end"}}>
                    {!readOnly&&<button onClick={e=>{e.stopPropagation();deletePanel(panel.id);}}
                      style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,padding:"4px 6px",borderRadius:4}}
                      onMouseEnter={e=>e.target.style.color=C.red}
                      onMouseLeave={e=>e.target.style.color=C.muted}>âœ•</button>}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ PANEL VIEW â”€â”€
function PanelView({project,panel:initPanel,uid,readOnly,onBack,onUpdatePanel,onViewQuote}){
  const [localPanel,setLocalPanel]=useState(initPanel);
  const [tab,setTab]=useState("drawings");

  function update(updatedPanel){
    setLocalPanel(updatedPanel);
    onUpdatePanel(updatedPanel);
  }

  async function saveImmediatePanel(updatedPanel){
    const newPanels=project.panels.map(p=>p.id===updatedPanel.id?updatedPanel:p);
    const fullProject={...project,panels:newPanels};
    await saveProject(uid,fullProject);
    setLocalPanel(updatedPanel);
    onUpdatePanel(updatedPanel);
  }

  const tabs=[
    {id:"drawings",icon:"ðŸ—‚ï¸",label:"Drawings"},
    {id:"extract",icon:"ðŸ”",label:"Extract"},
    {id:"validate",icon:"âœ…",label:"Validate"},
    {id:"price",icon:"ðŸ’²",label:"Price"},
  ];

  return(
    <div style={{minHeight:"100vh",display:"flex",flexDirection:"column",background:C.bg}}>
      <div style={{background:C.card,borderBottom:`1px solid ${C.border}`,padding:"0 24px",display:"flex",alignItems:"center",gap:16,minHeight:52,flexShrink:0}}>
        <button onClick={onBack} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,display:"flex",alignItems:"center",gap:6,padding:"0",whiteSpace:"nowrap"}}>â† Panels</button>
        <div style={{width:1,height:18,background:C.border}}/>
        <div style={{fontSize:13,color:C.muted,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:160}}>{project.name}</div>
        <div style={{color:C.muted,fontSize:13}}>/</div>
        <div style={{fontSize:15,fontWeight:700,color:C.text,flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{localPanel.name}</div>
        <Badge status={localPanel.status||"draft"}/>
        {readOnly&&<span style={{background:C.border,color:C.muted,borderRadius:20,padding:"2px 10px",fontSize:11,fontWeight:700}}>VIEW ONLY</span>}
        <div style={{fontSize:11,color:C.muted,whiteSpace:"nowrap"}}>{(localPanel.bom||[]).length} items Â· {(localPanel.pages||[]).length} pages</div>
      </div>
      <div style={{background:C.card,borderBottom:`1px solid ${C.border}`,padding:"0 24px",display:"flex",gap:4,flexShrink:0,overflowX:"auto"}}>
        {tabs.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)}
            style={{background:"none",border:"none",borderBottom:`2px solid ${tab===t.id?C.accent:"transparent"}`,color:tab===t.id?C.accent:C.muted,padding:"13px 14px",fontSize:13,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap",marginBottom:-1,transition:"color 0.15s"}}>
            {t.icon} {t.label}
          </button>
        ))}
      </div>
      <div style={{flex:1,overflowY:"auto",padding:24}}>
        <div style={{maxWidth:1200,margin:"0 auto"}}>
          {tab==="drawings"&&<DrawingsTab project={localPanel} uid={uid} onUpdate={update} onSaveImmediate={saveImmediatePanel} readOnly={readOnly} onNavigateTab={t=>{if(t==="quote"){onViewQuote&&onViewQuote();}else setTab(t);}}/>}
          {tab==="extract"&&<ExtractTab project={localPanel} uid={uid} onUpdate={update} onSaveImmediate={saveImmediatePanel} readOnly={readOnly}/>}
          {tab==="validate"&&<ValidateTab project={localPanel} uid={uid} onUpdate={update} onSaveImmediate={saveImmediatePanel} readOnly={readOnly}/>}
          {tab==="price"&&<PriceTab project={localPanel} uid={uid} onUpdate={update} onSaveImmediate={saveImmediatePanel} readOnly={readOnly}/>}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ QUOTE VIEW (aggregates all panels) â”€â”€
function QuoteView({project,uid,onBack,onUpdate}){
  const panels=project.panels||[];
  const allBom=mergeBoms(panels.map(p=>p.bom||[]));
  const totalWireCount=panels.reduce((s,p)=>s+(p.validation?.wireCount||0),0);
  const aggregated={
    ...project,
    bom:allBom,
    validation:{wireCount:totalWireCount},
    pricing:project.pricing||{},
    pages:panels.flatMap(p=>p.pages||[]),
  };
  function handleQuoteUpdate(upd){
    onUpdate({...project,quote:upd.quote,pricing:upd.pricing,budgetaryQuote:upd.budgetaryQuote});
  }
  const fmtMoney=n=>"$"+n.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0});
  return(
    <div style={{minHeight:"100vh",display:"flex",flexDirection:"column",background:C.bg}}>
      <div style={{background:C.card,borderBottom:`1px solid ${C.border}`,padding:"0 24px",display:"flex",alignItems:"center",gap:16,minHeight:52,flexShrink:0}}>
        <button onClick={onBack} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,display:"flex",alignItems:"center",gap:6,padding:"0",whiteSpace:"nowrap"}}>â† Panels</button>
        <div style={{width:1,height:18,background:C.border}}/>
        <div style={{fontSize:15,fontWeight:700,color:C.text,flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{project.name}</div>
        <span style={{background:C.greenDim,color:C.green,borderRadius:20,padding:"2px 10px",fontSize:11,fontWeight:700,whiteSpace:"nowrap"}}>COMBINED QUOTE</span>
        <div style={{fontSize:11,color:C.muted,whiteSpace:"nowrap"}}>{allBom.length} items Â· {totalWireCount} wires</div>
      </div>
      <div style={{flex:1,overflowY:"auto",padding:24}}>
        <div style={{maxWidth:1200,margin:"0 auto"}}>
          {panels.length>0&&(
            <div style={{...card({padding:"12px 16px"}),marginBottom:20}} className="no-print">
              <div style={{fontSize:12,color:C.muted,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5,marginBottom:10}}>Panel Breakdown</div>
              <div style={{display:"flex",flexWrap:"wrap",gap:12}}>
                {panels.map(p=>{
                  const mats=(p.bom||[]).reduce((s,r)=>s+(r.unitPrice||0)*(r.qty||1),0);
                  return(
                    <div key={p.id} style={{...card({padding:"10px 14px"}),minWidth:170}}>
                      <div style={{fontSize:13,fontWeight:700,marginBottom:4}}>{p.name}</div>
                      <div style={{fontSize:12,color:C.muted}}>{(p.bom||[]).length} items Â· {(p.pages||[]).length} pages</div>
                      {p.validation?.wireCount>0&&<div style={{fontSize:12,color:C.muted}}>âš¡ {p.validation.wireCount} wires</div>}
                      {mats>0&&<div style={{fontSize:12,color:C.green,marginTop:4}}>Materials: {fmtMoney(mats)}</div>}
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          <QuoteTab project={aggregated} onUpdate={handleQuoteUpdate}/>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ PROJECT VIEW â”€â”€
function ProjectView({project:init,uid,onBack,onChange}){
  const [project,setProject]=useState(()=>migrateProject(init));
  const projectRef=useRef(migrateProject(init));
  const [view,setView]=useState("panels"); // "panels"|"panel"|"quote"
  const [activePanel,setActivePanel]=useState(null);
  const saveTimer=useRef(null);
  const readOnly=isReadOnly();
  const didMigrate=useRef(!init.panels);

  // Keep ref in sync with state for use in callbacks
  useEffect(()=>{projectRef.current=project;},[project]);

  // Save migrated project immediately on first open
  useEffect(()=>{
    if(didMigrate.current){
      didMigrate.current=false;
      saveProject(uid,migrateProject(init)).catch(()=>{});
    }
  },[]);

  function update(p){
    setProject(p);projectRef.current=p;onChange(p);
    clearTimeout(saveTimer.current);
    saveTimer.current=setTimeout(()=>saveProject(uid,p),1000);
  }

  function updatePanel(panelId,updatedPanel){
    const cur=projectRef.current;
    const newPanels=cur.panels.map(p=>p.id===panelId?updatedPanel:p);
    const newProject={...cur,panels:newPanels};
    setActivePanel(updatedPanel);
    update(newProject);
  }

  if(view==="panel"&&activePanel){
    return(
      <PanelView
        project={project}
        panel={activePanel}
        uid={uid}
        readOnly={readOnly}
        onBack={()=>{setView("panels");setActivePanel(null);}}
        onUpdatePanel={updatedPanel=>updatePanel(activePanel.id,updatedPanel)}
        onViewQuote={()=>setView("quote")}
      />
    );
  }

  if(view==="quote"){
    return(
      <QuoteView
        project={project}
        uid={uid}
        onBack={()=>setView("panels")}
        onUpdate={update}
      />
    );
  }

  return(
    <PanelListView
      project={project}
      uid={uid}
      readOnly={readOnly}
      onBack={onBack}
      onOpenPanel={panel=>{setActivePanel(panel);setView("panel");}}
      onViewQuote={()=>setView("quote")}
      onUpdate={update}
    />
  );
}

// â”€â”€ SETTINGS MODAL â”€â”€
function SettingsModal({uid,onClose}){
  const [key,setKey]=useState("");
  const [loading,setLoading]=useState(true);
  const [saved,setSaved]=useState(false);

  const [curPass,setCurPass]=useState("");
  const [newPass,setNewPass]=useState("");
  const [confPass,setConfPass]=useState("");
  const [pwLoading,setPwLoading]=useState(false);
  const [pwErr,setPwErr]=useState("");
  const [pwOk,setPwOk]=useState(false);
  const [resetSent,setResetSent]=useState(false);

  useEffect(()=>{
    fbDb.doc(`users/${uid}/config/api`).get()
      .then(d=>{if(d.exists)setKey(d.data().key||"");})
      .finally(()=>setLoading(false));
  },[uid]);

  async function save(){
    await fbDb.doc(`users/${uid}/config/api`).set({key});
    _apiKey=key;setSaved(true);setTimeout(()=>setSaved(false),2000);
  }

  async function sendReset(){
    setPwErr("");setPwLoading(true);
    try{
      await fbAuth.sendPasswordResetEmail(fbAuth.currentUser.email);
      setResetSent(true);
    }catch(ex){setPwErr(ex.message);}
    setPwLoading(false);
  }

  async function changePassword(e){
    e.preventDefault();setPwErr("");
    if(newPass.length<6){setPwErr("New password must be at least 6 characters.");return;}
    if(newPass!==confPass){setPwErr("Passwords do not match.");return;}
    setPwLoading(true);
    try{
      const user=fbAuth.currentUser;
      const cred=firebase.auth.EmailAuthProvider.credential(user.email,curPass);
      await user.reauthenticateWithCredential(cred);
      await user.updatePassword(newPass);
      setPwOk(true);setCurPass("");setNewPass("");setConfPass("");
      setTimeout(()=>setPwOk(false),3000);
    }catch(ex){
      if(ex.code==="auth/wrong-password"||ex.code==="auth/invalid-credential")setPwErr("Current password is incorrect.");
      else if(ex.code==="auth/operation-not-allowed")setPwErr("Password sign-in is not enabled for this account.");
      else setPwErr(ex.message);
    }
    setPwLoading(false);
  }

  const isEmailProvider=fbAuth.currentUser?.providerData?.some(p=>p.providerId==="password");

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div style={{...card(),width:"100%",maxWidth:460}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>âš™ Settings</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:20}}>Matrix ARC configuration</div>

        <div style={{marginBottom:20}}>
          <label style={{fontSize:12,color:C.sub,display:"block",marginBottom:6,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5}}>Anthropic API Key</label>
          {loading
            ?<div style={{color:C.muted,fontSize:13,padding:"9px 0"}}>Loadingâ€¦</div>
            :<input value={key} onChange={e=>setKey(e.target.value)} type="password" placeholder="sk-ant-â€¦" style={inp()}/>
          }
          <div style={{fontSize:11,color:C.muted,marginTop:6}}>Stored in your Firebase project. Shared across all team members.</div>
        </div>
        <div style={{display:"flex",gap:10,marginBottom:24}}>
          <button onClick={onClose} style={btn(C.border,C.sub,{flex:1})}>Close</button>
          <button onClick={save} disabled={loading||!key.trim()} style={btn(saved?C.green:C.accent,"#fff",{flex:2,opacity:loading||!key.trim()?0.5:1})}>
            {saved?"âœ“ Saved":"Save Key"}
          </button>
        </div>

        <div style={{borderTop:`1px solid ${C.border}`,paddingTop:20}}>
          <label style={{fontSize:12,color:C.sub,display:"block",marginBottom:12,fontWeight:600,textTransform:"uppercase",letterSpacing:0.5}}>Change Password</label>
          {!isEmailProvider?(
            <div style={{fontSize:13,color:C.muted,padding:"10px 12px",background:C.surface,borderRadius:8}}>
              Your account uses Google Sign-In and does not have a password. Use "Forgot password?" on the login screen to set one.
            </div>
          ):(
            <form onSubmit={changePassword}>
              <div style={{marginBottom:4}}><input value={curPass} onChange={e=>setCurPass(e.target.value)} type="password" placeholder="Current password" style={inp()} required/></div>
              <div style={{textAlign:"right",marginBottom:10}}>
                {resetSent
                  ?<span style={{fontSize:12,color:C.green}}>âœ“ Reset link sent to {fbAuth.currentUser?.email}</span>
                  :<button type="button" onClick={sendReset} disabled={pwLoading} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:12,padding:0}}>Forgot password?</button>
                }
              </div>
              <div style={{marginBottom:8}}><input value={newPass} onChange={e=>setNewPass(e.target.value)} type="password" placeholder="New password (min 6 chars)" style={inp()} required/></div>
              <div style={{marginBottom:10}}><input value={confPass} onChange={e=>setConfPass(e.target.value)} type="password" placeholder="Confirm new password" style={inp()} required/></div>
              {pwErr&&<div style={{color:C.red,fontSize:12,marginBottom:10,lineHeight:1.5}}>{pwErr}</div>}
              {pwOk&&<div style={{color:C.green,fontSize:12,marginBottom:10}}>âœ“ Password updated successfully.</div>}
              <button type="submit" disabled={pwLoading} style={btn(C.accent,"#fff",{width:"100%",opacity:pwLoading?0.6:1})}>
                {pwLoading?"Updatingâ€¦":"Update Password"}
              </button>
            </form>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ NEW PROJECT MODAL â”€â”€
function NewProjectModal({uid,onCreated,onClose}){
  const [name,setName]=useState("");
  const [loading,setLoading]=useState(false);

  async function create(e){
    e.preventDefault();if(!name.trim())return;setLoading(true);
    const p=await saveProject(uid,{name:name.trim(),status:"draft",panels:[{id:'panel-1',name:'Panel 1',pages:[],bom:[],validation:null,pricing:null,budgetaryQuote:null,status:'draft'}],createdAt:Date.now(),updatedAt:Date.now()});
    onCreated(p);
  }

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div style={{...card(),width:"100%",maxWidth:440}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:20,fontWeight:700,marginBottom:4}}>New Project</div>
        <div style={{fontSize:13,color:C.muted,marginBottom:20}}>Name this control panel quote</div>
        <form onSubmit={create}>
          <input value={name} onChange={e=>setName(e.target.value)} placeholder="e.g. Panel 2024-001 â€” Conveyor Control" style={{...inp(),marginBottom:16}} autoFocus/>
          <div style={{display:"flex",gap:10}}>
            <button type="button" onClick={onClose} style={btn(C.border,C.sub,{flex:1})}>Cancel</button>
            <button type="submit" disabled={!name.trim()||loading} style={btn(C.accent,"#fff",{flex:2,opacity:!name.trim()||loading?0.5:1})}>
              {loading?"Creatingâ€¦":"Create Project"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// â”€â”€ DASHBOARD â”€â”€
function Dashboard({uid,projects,loading,onOpen,onNew,onDelete,onAccept}){
  return(
    <div style={{maxWidth:1100,margin:"0 auto",padding:32}}>

      {/* Hero logo */}
      <div style={{textAlign:"center",padding:"48px 0 52px",background:`radial-gradient(ellipse at 50% 0%,#1a1a3e 0%,transparent 70%)`,borderRadius:16,marginBottom:40}}>
        <div style={{fontSize:110,lineHeight:1,marginBottom:16}}>â¬¡</div>
        <div style={{fontSize:80,fontWeight:800,letterSpacing:-3,lineHeight:1,marginBottom:12}}>
          Matrix <span style={{color:C.accent}}>ARC</span>
        </div>
        <div style={{fontSize:16,color:C.muted,letterSpacing:1}}>AI Recognition &amp; Capture Â· Control Panel Quoting</div>
        <div style={{fontSize:14,color:C.sub,marginTop:8}}>AI assisted Industrial Control Panel extraction and Quoting assistant</div>
      </div>

      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:32}}>
        <div>
          <div style={{fontSize:26,fontWeight:800,letterSpacing:-0.5}}>Projects</div>
          <div style={{fontSize:13,color:C.muted,marginTop:4}}>Control panel quote extraction</div>
        </div>
        <button onClick={onNew} style={btn(C.accent,"#fff",{display:"flex",alignItems:"center",gap:8,fontSize:14})}>
          <span style={{fontSize:18,lineHeight:1}}>+</span> New Project
        </button>
      </div>

      {loading&&(
        <div style={{textAlign:"center",padding:80,color:C.muted}}>
          <div className="spin" style={{fontSize:24,marginBottom:12}}>â—Œ</div>
          <div>Loading projectsâ€¦</div>
        </div>
      )}

      {(()=>{
        const myProjects=projects.filter(p=>!p.transferred||p.transferredTo!==uid);
        const transferred=projects.filter(p=>p.transferred&&p.transferredTo===uid);
        return(<>
          {!loading&&myProjects.length===0&&transferred.length===0&&(
            <div style={{textAlign:"center",padding:80,color:C.muted}}>
              <div style={{fontSize:52,marginBottom:16,opacity:0.2}}>â¬¡</div>
              <div style={{fontSize:18,fontWeight:700,color:C.sub,marginBottom:8}}>No projects yet</div>
              <div style={{fontSize:13,marginBottom:24,lineHeight:1.7}}>Upload scanned UL508A drawings to extract<br/>BOM data, validate schematics, and generate quotes.</div>
              <button onClick={onNew} style={btn(C.accent,"#fff")}>Create First Project</button>
            </div>
          )}
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(290px,1fr))",gap:16}}>
            {myProjects.map(p=>(
              <div key={p.id} className="fade-in" onClick={()=>onOpen(p)}
                style={{...card(),cursor:"pointer",transition:"border-color 0.15s,transform 0.15s"}}
                onMouseEnter={e=>{e.currentTarget.style.borderColor=C.accent+"66";e.currentTarget.style.transform="translateY(-2px)";}}
                onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.transform="none";}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
                  <div style={{fontSize:15,fontWeight:700,flex:1,marginRight:10,color:C.text,lineHeight:1.3}}>{p.name}</div>
                  <Badge status={p.status||"draft"}/>
                </div>
                <div style={{display:"flex",gap:16,fontSize:12,color:C.muted,marginBottom:14,flexWrap:"wrap"}}>
                  <span>ðŸ“‹ {p.panels?p.panels.reduce((s,pl)=>s+(pl.bom||[]).length,0):(p.bom||[]).length} items</span>
                  <span>ðŸ–¼ï¸ {p.panels?p.panels.reduce((s,pl)=>s+(pl.pages||[]).length,0):(p.pages||[]).length} pages</span>
                  {p.panels&&<span>â¬¡ {p.panels.length} panel{p.panels.length!==1?"s":""}</span>}
                </div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{fontSize:11,color:C.muted}}>{p.updatedAt?new Date(p.updatedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"â€”"}</div>
                  <button onClick={e=>{e.stopPropagation();onDelete(p.id);}} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,padding:"4px 6px",borderRadius:4}} onMouseEnter={e=>e.target.style.color=C.red} onMouseLeave={e=>e.target.style.color=C.muted}>âœ•</button>
                </div>
              </div>
            ))}
          </div>
          {transferred.length>0&&(
            <div style={{marginTop:48}}>
              <div style={{fontSize:14,fontWeight:700,color:C.yellow,marginBottom:4,textTransform:"uppercase",letterSpacing:0.5}}>Transferred Projects</div>
              <div style={{fontSize:12,color:C.muted,marginBottom:20}}>These projects were transferred to you. Accept them to add them to your project list.</div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(290px,1fr))",gap:16}}>
                {transferred.map(p=>(
                  <div key={p.id} className="fade-in" onClick={()=>onOpen(p)}
                    style={{...card(),cursor:"pointer",borderColor:C.yellow+"44",transition:"border-color 0.15s,transform 0.15s"}}
                    onMouseEnter={e=>{e.currentTarget.style.borderColor=C.yellow;e.currentTarget.style.transform="translateY(-2px)";}}
                    onMouseLeave={e=>{e.currentTarget.style.borderColor=C.yellow+"44";e.currentTarget.style.transform="none";}}>
                    <div style={{fontSize:10,color:C.yellow,fontWeight:700,textTransform:"uppercase",letterSpacing:0.5,marginBottom:8}}>
                      Transferred from {p.transferredFrom?.email||"a removed member"}
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
                      <div style={{fontSize:15,fontWeight:700,flex:1,marginRight:10,color:C.text,lineHeight:1.3}}>{p.name}</div>
                      <Badge status={p.status||"draft"}/>
                    </div>
                    <div style={{display:"flex",gap:16,fontSize:12,color:C.muted,marginBottom:14,flexWrap:"wrap"}}>
                      <span>ðŸ“‹ {p.panels?p.panels.reduce((s,pl)=>s+(pl.bom||[]).length,0):(p.bom||[]).length} items</span>
                      <span>ðŸ–¼ï¸ {p.panels?p.panels.reduce((s,pl)=>s+(pl.pages||[]).length,0):(p.pages||[]).length} pages</span>
                    </div>
                    <button onClick={e=>{e.stopPropagation();onAccept(p.id);}}
                      style={btn(C.yellow,"#000",{width:"100%",fontSize:12,padding:"6px 0",fontWeight:700})}>
                      Accept into My Projects
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </>);
      })()}
    </div>
  );
}

// â”€â”€ APP â”€â”€
function App({user}){
  const [projects,setProjects]=useState([]);
  const [loading,setLoading]=useState(true);
  const [view,setView]=useState("dashboard");
  const [openProject,setOpenProject]=useState(null);
  const [showNew,setShowNew]=useState(false);
  const [showSettings,setShowSettings]=useState(false);
  const [showConfig,setShowConfig]=useState(false);
  const [companyId,setCompanyId]=useState(null);
  const [userRole,setUserRole]=useState(null);
  const [companyName,setCompanyName]=useState(null);
  const [showTeam,setShowTeam]=useState(false);
  const [showSetup,setShowSetup]=useState(false);
  const [setupDismissed,setSetupDismissed]=useState(false);

  useEffect(()=>{
    (async()=>{
      _appCtx.uid=user.uid;
      const profile=await loadUserProfile(user.uid);
      if(profile?.companyId){
        _appCtx.companyId=profile.companyId;
        _appCtx.role=profile.role;
        _appCtx.projectsPath=`companies/${profile.companyId}/projects`;
        _appCtx.configPath=`companies/${profile.companyId}/config`;
        setCompanyId(profile.companyId);
        setUserRole(profile.role);
        try{
          const cd=await fbDb.doc(`companies/${profile.companyId}`).get();
          if(cd.exists)setCompanyName(cd.data().name||null);
        }catch(e){}
      } else {
        _appCtx.projectsPath=`users/${user.uid}/projects`;
      }
      await Promise.all([loadApiKey(user.uid),loadPricingConfig(user.uid)]);
      setProjects(await loadProjects(user.uid));
      setLoading(false);
    })();
  },[user.uid]);

  function handleOpen(p){setOpenProject(p);setView("project");}
  function handleCreated(p){setShowNew(false);setProjects(ps=>[p,...ps]);setOpenProject(p);setView("project");}
  function handleChange(p){setProjects(ps=>ps.map(x=>x.id===p.id?p:x));setOpenProject(p);}
  function handleDelete(id){if(!confirm("Delete this project?"))return;deleteProject(user.uid,id);setProjects(ps=>ps.filter(x=>x.id!==id));}
  async function handleAccept(id){
    const path=_appCtx.projectsPath||`users/${user.uid}/projects`;
    await fbDb.doc(`${path}/${id}`).update({
      transferred:firebase.firestore.FieldValue.delete(),
      transferredTo:firebase.firestore.FieldValue.delete(),
      transferredFrom:firebase.firestore.FieldValue.delete(),
      createdBy:user.uid,
    });
    setProjects(ps=>ps.map(p=>p.id===id?{...p,transferred:undefined,transferredTo:undefined,transferredFrom:undefined,createdBy:user.uid}:p));
  }

  return(
    <div style={{minHeight:"100vh",background:C.bg}}>
      {view==="dashboard"&&(
        <>
          <div style={{background:C.card,borderBottom:`1px solid ${C.border}`,padding:"0 32px",display:"flex",alignItems:"center",height:52}}>
            <div style={{display:"flex",alignItems:"center",gap:10,flex:1}}>
              <span style={{fontSize:22}}>â¬¡</span>
              <span style={{fontSize:16,fontWeight:800,letterSpacing:-0.5}}>Matrix <span style={{color:C.accent}}>ARC</span></span>
              <span style={{fontSize:11,color:C.muted,marginLeft:4}}>AI Recognition &amp; Capture</span>
              {companyName&&(
                <span style={{color:C.accent,fontSize:12,fontWeight:700,marginLeft:8}}>â¬¡ {companyName}</span>
              )}
            </div>
            <div style={{display:"flex",gap:8,alignItems:"center"}}>
              <button onClick={()=>setShowTeam(true)} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,padding:"6px 10px",borderRadius:6}}>ðŸ‘¥ Team</button>
              <button onClick={()=>setShowConfig(true)} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,padding:"6px 10px",borderRadius:6}}>âš™ Config</button>
              <button onClick={()=>setShowSettings(true)} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:13,padding:"6px 10px",borderRadius:6}}>âš™ Settings</button>
              <div style={{width:1,height:18,background:C.border}}/>
              <span style={{fontSize:12,color:C.muted}}>{user.email}</span>
              {userRole&&<span style={{fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:10,background:userRole==="admin"?C.accentDim:userRole==="edit"?C.greenDim:C.border,color:userRole==="admin"?C.accent:userRole==="edit"?C.green:C.muted}}>{userRole}</span>}
              <button onClick={()=>fbAuth.signOut()} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:12,padding:"6px 10px"}}>Sign out</button>
            </div>
          </div>
          {/* Company setup banner */}
          {!companyId&&!setupDismissed&&(
            <div style={{background:"#1a1a3e",borderBottom:`1px solid ${C.accent}44`,padding:"8px 32px",display:"flex",alignItems:"center",gap:12,fontSize:13,flexWrap:"wrap"}}>
              <span style={{color:C.sub,flex:1}}>Set up a Company workspace to collaborate with your team.</span>
              <button onClick={()=>setShowSetup(true)} style={btn(C.accent,"#fff",{fontSize:12,padding:"5px 14px"})}>Set up Company</button>
              <button onClick={()=>setSetupDismissed(true)} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:12,padding:"4px 8px"}}>Not now</button>
            </div>
          )}
          <Dashboard uid={user.uid} projects={projects} loading={loading} onOpen={handleOpen} onNew={()=>setShowNew(true)} onDelete={handleDelete} onAccept={handleAccept}/>
        </>
      )}
      {view==="project"&&openProject&&(
        <ProjectView project={openProject} uid={user.uid} onBack={()=>setView("dashboard")} onChange={handleChange}/>
      )}
      {showNew&&<NewProjectModal uid={user.uid} onCreated={handleCreated} onClose={()=>setShowNew(false)}/>}
      {showSettings&&<SettingsModal uid={user.uid} onClose={()=>setShowSettings(false)}/>}
      {showConfig&&<PricingConfigModal uid={user.uid} onClose={()=>setShowConfig(false)}/>}
      {showTeam&&<TeamModal uid={user.uid} companyId={companyId} userRole={userRole} onClose={()=>setShowTeam(false)}/>}
      {showSetup&&<CompanySetupModal uid={user.uid} email={user.email} onDone={(cid,role,name)=>{setCompanyId(cid);setUserRole(role);setCompanyName(name||null);setShowSetup(false);}} onClose={()=>setShowSetup(false)}/>}
    </div>
  );
}

// â”€â”€ ROOT â”€â”€
function Root(){
  const [user,setUser]=useState(undefined);
  const [redirectDone,setRedirectDone]=useState(false);

  useEffect(()=>{setRedirectDone(true);},[]);
  const [joinPayload]=useState(()=>{
    try{
      const params=new URLSearchParams(window.location.search);
      const j=params.get("join");
      if(!j)return null;
      return JSON.parse(atob(j));
    }catch(e){return null;}
  });

  useEffect(()=>{
    return fbAuth.onAuthStateChanged(u=>{
      if(u&&joinPayload){
        // If signed in as a different user, sign out and show the invite login screen
        if(u.email.toLowerCase()!==joinPayload.e.toLowerCase()){
          fbAuth.signOut();
          return; // onAuthStateChanged will fire again with null â†’ shows LoginScreen
        }
        const{c:companyId,r:role}=joinPayload;
        const batch=fbDb.batch();
        batch.set(fbDb.doc(`companies/${companyId}/members/${u.uid}`),{email:u.email,role,addedAt:Date.now()});
        batch.set(fbDb.doc(`users/${u.uid}/config/profile`),{companyId,role},{merge:true});
        batch.commit()
          .then(()=>{
            try{
              const url=new URL(window.location.href);
              url.searchParams.delete("join");
              window.history.replaceState({},"",url.toString());
            }catch(e){}
            setUser(u);
          })
          .catch(e=>{
            console.error("Failed to accept invite:",e);
            setUser(u);
          });
      } else {
        setUser(u);
      }
    });
  },[joinPayload]);

  if(user===undefined||!redirectDone)return(
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:C.bg}}>
      <div style={{color:C.muted,fontSize:14}}>Loadingâ€¦</div>
    </div>
  );
  if(!user)return<LoginScreen invite={joinPayload}/>;
  return<App user={user}/>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<Root/>);
</script>
</body>
</html>
